{{/*
  Publication extras: Key contributions, artifacts, related papers, citation block.
  Usage: {{< publication_extras >}}
*/}}

{{ $page := .Page }}
{{ $currentUrl := $page.RelPermalink }}
{{ if not (hasSuffix $currentUrl "/") }}{{ $currentUrl = printf "%s/" $currentUrl }}{{ end }}

{{ $abstract := $page.Params.abstract | default "" }}
{{ $abstractClean := replaceRE "\\r|\\n" " " $abstract | replaceRE "\\s+" " " | trim " " }}

{{ $contribs := $page.Params.key_contributions }}
{{ if not $contribs }}
  {{ $scratch := newScratch }}
  {{ $scratch.Set "auto" (slice) }}
  {{ $sentences := split $abstractClean "." }}
  {{ range $sentences }}
    {{ $s := trim . " " }}
    {{ if gt (len $s) 30 }}
      {{ $scratch.Set "auto" (append ($scratch.Get "auto") (printf "%s." $s)) }}
    {{ end }}
  {{ end }}
  {{ $contribs = first 3 ($scratch.Get "auto") }}
{{ end }}

{{ $authors := slice }}
{{ range $page.Params.authors }}
  {{ $name := . }}
  {{ with $.Site.GetPage (printf "/authors/%s" .) }}
    {{ $name = .Title }}
  {{ end }}
  {{ $authors = $authors | append $name }}
{{ end }}
{{ $authorsStr := delimit $authors ", " }}

{{ $year := $page.Date.Format "2006" }}
{{ with $page.Params.year }}{{ $year = printf "%v" . }}{{ end }}

{{ $venue := $page.Params.publication | default $page.Params.publication_short | default $page.Params.venue | default "" }}
{{ $venuePlain := $venue | plainify }}

{{ $doi := "" }}
{{ with $page.Params.doi }}
  {{ if ne . "" }}{{ $doi = . }}{{ end }}
{{ end }}

{{ $authorCount := len $authors }}
{{ $authorsApa := $authorsStr }}
{{ $authorsChicago := $authorsStr }}
{{ if eq $authorCount 1 }}
  {{ $authorsApa = index $authors 0 }}
  {{ $authorsChicago = index $authors 0 }}
{{ else if eq $authorCount 2 }}
  {{ $authorsApa = printf "%s & %s" (index $authors 0) (index $authors 1) }}
  {{ $authorsChicago = printf "%s and %s" (index $authors 0) (index $authors 1) }}
{{ else if gt $authorCount 2 }}
  {{ $firsts := first (sub $authorCount 1) $authors }}
  {{ $last := index $authors (sub $authorCount 1) }}
  {{ $authorsApa = printf "%s, & %s" (delimit $firsts ", ") $last }}
  {{ $authorsChicago = printf "%s, and %s" (delimit $firsts ", ") $last }}
{{ end }}


{{ $pubData := .Site.Data.publications }}
{{ if isSet $pubData 0 }}
{{ else if isSet $pubData "individualPublications" }}
  {{ $pubData = $pubData.individualPublications }}
{{ end }}

{{ $current := dict }}
{{ range $pubData }}
  {{ if eq .url $currentUrl }}
    {{ $current = . }}
  {{ end }}
{{ end }}

{{ $currentTitle := $page.Title | default $current.title }}
{{ $currentVenue := $current.venue | default $venuePlain }}
{{ $currentType := $current.type | default "" }}

{{ $citationApa := printf "%s (%s). %s.%s" $authorsApa $year $page.Title (cond (ne $currentVenue "") (printf " %s" $currentVenue) "") }}
{{ $citationChicago := printf "%s. %s. \"%s.\"%s" $authorsChicago $year $page.Title (cond (ne $currentVenue "") (printf " %s" $currentVenue) "") }}
{{ if $doi }}
  {{ $citationApa = printf "%s https://doi.org/%s" $citationApa $doi }}
  {{ $citationChicago = printf "%s https://doi.org/%s" $citationChicago $doi }}
{{ end }}

{{ $bibEntryType := "misc" }}
{{ if or (eq $currentType "journal") (eq $page.Section "journal_publication") }}
  {{ $bibEntryType = "article" }}
{{ else if or (eq $currentType "conference") (eq $currentType "workshop") (eq $page.Section "conference_publication") (eq $page.Section "workshop_publication") }}
  {{ $bibEntryType = "inproceedings" }}
{{ end }}
{{ $bibVenueField := cond (eq $bibEntryType "article") "journal" "booktitle" }}

{{ $citationKey := "ampel" }}
{{ if gt (len $authors) 0 }}
  {{ $firstAuthor := index $authors 0 }}
  {{ $nameParts := split $firstAuthor " " }}
  {{ if gt (len $nameParts) 0 }}
    {{ $citationKey = lower (replaceRE "[^a-z]" "" (index $nameParts (sub (len $nameParts) 1))) }}
  {{ end }}
{{ end }}
{{ $titleKey := "" }}
{{ if $currentTitle }}
  {{ $titleParts := split (lower $currentTitle) " " }}
  {{ if gt (len $titleParts) 0 }}
    {{ $titleKey = replaceRE "[^a-z0-9]" "" (index $titleParts 0) }}
  {{ end }}
{{ end }}
{{ $citationKey = printf "%s%s%s" $citationKey $year $titleKey }}

{{ $venueLine := "" }}
{{ if $currentVenue }}
  {{ $venueLine = printf "  %s={%s},\n" $bibVenueField $currentVenue }}
{{ end }}
{{ $doiLine := "" }}
{{ if $doi }}
  {{ $doiLine = printf ",\n  doi={%s}" $doi }}
{{ end }}
{{ $bibtex := printf "@%s{%s,\n  title={%s},\n  author={%s},\n%s  year={%s}%s\n}" $bibEntryType $citationKey $page.Title (delimit $authors " and ") $venueLine $year $doiLine }}

{{ $titleTokens := slice }}
{{ if $currentTitle }}
  {{ $cleanTitle := replaceRE "[^a-z0-9 ]" "" (lower $currentTitle) }}
  {{ range split $cleanTitle " " }}
    {{ if gt (len .) 3 }}{{ $titleTokens = $titleTokens | append . }}{{ end }}
  {{ end }}
{{ end }}

{{ $related := slice }}
{{ range $pubData }}
  {{ if ne .url $currentUrl }}
    {{ $score := 0 }}
    {{ if and $currentVenue (eq .venue $currentVenue) }}{{ $score = add $score 3 }}{{ end }}
    {{ if and $currentType (eq .type $currentType) }}{{ $score = add $score 2 }}{{ end }}
    {{ $tokens := slice }}
    {{ $cleanCandidate := replaceRE "[^a-z0-9 ]" "" (lower .title) }}
    {{ range split $cleanCandidate " " }}
      {{ if gt (len .) 3 }}{{ $tokens = $tokens | append . }}{{ end }}
    {{ end }}
    {{ $overlap := intersect $tokens $titleTokens }}
    {{ $score = add $score (len $overlap) }}
    {{ if gt $score 0 }}
      {{ $related = $related | append (dict "item" . "score" $score) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $related = sort $related "score" "desc" }}

<div class="pub-extras">
  <div class="pub-extras-grid">
    <div class="pub-extras-card">
      <h3>Key Contributions</h3>
      {{ if $contribs }}
        <ul>
          {{ range $contribs }}
            <li>{{ . }}</li>
          {{ end }}
        </ul>
      {{ else }}
        <p class="pub-muted">Key contributions will be added soon.</p>
      {{ end }}
    </div>

    <div class="pub-extras-card">
      <h3>Artifacts</h3>
      {{ $artifacts := slice }}
      {{ with $page.Params.url_pdf }}{{ if ne . "" }}{{ $artifacts = $artifacts | append (dict "label" "PDF" "url" .) }}{{ end }}{{ end }}
      {{ with $page.Params.url_code }}{{ if ne . "" }}{{ $artifacts = $artifacts | append (dict "label" "Code" "url" .) }}{{ end }}{{ end }}
      {{ with $page.Params.url_dataset }}{{ if ne . "" }}{{ $artifacts = $artifacts | append (dict "label" "Data" "url" .) }}{{ end }}{{ end }}
      {{ with $page.Params.url_project }}{{ if ne . "" }}{{ $artifacts = $artifacts | append (dict "label" "Project" "url" .) }}{{ end }}{{ end }}
      {{ with $page.Params.url_slides }}{{ if ne . "" }}{{ $artifacts = $artifacts | append (dict "label" "Slides" "url" .) }}{{ end }}{{ end }}
      {{ with $page.Params.url_video }}{{ if ne . "" }}{{ $artifacts = $artifacts | append (dict "label" "Video" "url" .) }}{{ end }}{{ end }}

      {{ if gt (len $artifacts) 0 }}
        <div class="pub-artifacts">
          {{ range $artifacts }}
            {{ $href := .url }}
            {{ if not (hasPrefix $href "http") }}{{ $href = relURL $href }}{{ end }}
            <a class="pub-chip" href="{{ $href }}" target="_blank" rel="noopener">{{ .label }}</a>
          {{ end }}
        </div>
      {{ else }}
        <p class="pub-muted">No artifacts listed yet.</p>
      {{ end }}
    </div>

    <div class="pub-extras-card">
      <h3>Related Papers</h3>
      {{ if gt (len $related) 0 }}
        <ul class="pub-related">
          {{ range first 3 $related }}
            {{ $item := .item }}
            <li>
              <a href="{{ $item.url | relURL }}">{{ $item.title }}</a>
              <span>{{ $item.year }} Â· {{ $item.venue }}</span>
            </li>
          {{ end }}
        </ul>
      {{ else }}
        <p class="pub-muted">Related papers will appear as the catalog grows.</p>
      {{ end }}
    </div>

    <div class="pub-extras-card">
      <h3>Citation</h3>
      <div class="pub-citation">
        <div class="pub-citation-text">{{ $citationApa }}</div>
        <div class="pub-citation-actions">
          <button class="pub-copy" type="button" data-copy-text="{{ $citationApa | urlquery }}" data-copy-label="APA">Copy APA</button>
          <button class="pub-copy" type="button" data-copy-text="{{ $citationChicago | urlquery }}" data-copy-label="Chicago">Copy Chicago</button>
          <button class="pub-copy" type="button" data-copy-text="{{ $bibtex | urlquery }}" data-copy-label="BibTeX">Copy BibTeX</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.pub-extras { margin-top: 2rem; }
.pub-extras-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:16px; }
.pub-extras-card { border:1px solid var(--card-border, #333); border-radius:14px; padding:16px; background:var(--card-bg, rgba(0,0,0,0.25)); box-shadow:0 8px 20px rgba(0,0,0,0.12); }
.pub-extras-card h3 { margin:0 0 10px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.08em; color:#00ff41; }
.pub-extras-card ul { margin:0; padding-left:18px; }
.pub-extras-card li { margin-bottom:6px; font-size:0.82rem; line-height:1.4; }
.pub-muted { font-size:0.8rem; opacity:0.7; }
.pub-artifacts { display:flex; flex-wrap:wrap; gap:8px; }
.pub-chip { font-size:0.7rem; text-transform:uppercase; letter-spacing:0.08em; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,229,255,0.35); color:#bde8ff; background:rgba(0,229,255,0.1); text-decoration:none; }
.pub-related { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
.pub-related li { display:flex; flex-direction:column; gap:2px; }
.pub-related a { color:#00e5ff; text-decoration:none; font-size:0.82rem; }
.pub-related span { font-size:0.72rem; opacity:0.7; }
.pub-citation { display:flex; flex-direction:column; gap:10px; }
.pub-citation-text { font-size:0.8rem; line-height:1.4; background:rgba(0,0,0,0.35); border-radius:10px; padding:10px; border:1px solid rgba(0,255,65,0.2); }
.pub-citation-actions { display:flex; flex-wrap:wrap; gap:8px; }
.pub-copy { align-self:flex-start; border-radius:999px; border:1px solid rgba(0,255,65,0.4); color:#00ff41; background:rgba(0,255,65,0.12); padding:6px 12px; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.08em; cursor:pointer; }
.pub-copy.copied { color:#111; background:#00ff41; }

body:not(.dark) .pub-extras-card { background:rgba(255,255,255,0.92); }
body:not(.dark) .pub-extras-card h3 { color:#0b7a2f; }
body:not(.dark) .pub-citation-text { background:rgba(255,255,255,0.9); }
</style>
