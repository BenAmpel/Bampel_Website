{{/* Research Command Center - Restored Manuscript Impact Network */}}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div id="dashboard-root" style="min-height: 550px; margin: 30px 0;"></div>

<script type="text/javascript">
(function() {
    var root = document.getElementById('dashboard-root');
    var radarChart, lineChart, graphChart;

    // --- 1. LAYOUT GENERATOR (Fixed Height Logic) ---
    function renderLayout() {
        var isDark = document.body.classList.contains('dark');
        var bg = isDark ? 'rgba(255,255,255,0.02)' : '#ffffff';
        var border = isDark ? '#333' : '#eee';
        var muted = isDark ? '#888' : '#666';
        var text = isDark ? '#aaa' : '#333';
        var highlight = isDark ? '#00e5ff' : '#1a0dab';
        var shadow = isDark ? 'rgba(0,0,0,0.5)' : 'rgba(0,0,0,0.05)';
        
        var c1 = isDark ? '#00ff41' : '#d93025'; 
        var c2 = isDark ? '#00e5ff' : '#1a0dab'; 
        var c3 = isDark ? '#e040fb' : '#9c27b0'; 

        // FIX 1: Changed grid-template-rows to 'auto 500px' to guarantee map height
        return `
        <div id="research-card" style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto 500px; gap: 0; background: ${bg}; border: 1px solid ${border}; border-radius: 12px; box-shadow: 0 4px 20px ${shadow}; overflow: hidden; margin-bottom: 30px;">
            
            <div style="grid-column: 1; grid-row: 1; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid ${border}; border-bottom: 1px solid ${border};">
                <h4 style="margin: 0 0 10px; font-size: 0.9rem; color: ${muted}; text-transform: uppercase; letter-spacing: 1px; text-align: center;">Research Profile</h4>
                <div id="dash-radar" style="width: 100%; height: 300px;"></div>
            </div>

            <div style="grid-column: 2; grid-row: 1; padding: 25px; border-bottom: 1px solid ${border}; display: flex; flex-direction: column;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div><div style="font-size: 0.8rem; color: ${muted};">Primary Focus</div><div style="font-size: 1.1rem; font-weight: 800; color: ${c1};" id="metric-focus">...</div></div>
                    <div><div style="font-size: 0.8rem; color: ${muted};">Trending</div><div style="font-size: 1.1rem; font-weight: 800; color: ${c2};" id="metric-trend">...</div></div>
                    <div><div style="font-size: 0.8rem; color: ${muted};">Velocity</div><div style="font-size: 1.1rem; font-weight: 800; color: ${c2};" id="metric-velocity">-</div></div>
                    <div><div style="font-size: 0.8rem; color: ${muted};">Total Citations</div><div style="font-size: 1.5rem; font-weight: 800; color: ${c3};" id="metric-cites">0</div></div>
                    <div><div style="font-size: 0.8rem; color: ${muted};">h-index</div><div style="font-size: 1.5rem; font-weight: 800; color: ${text};" id="metric-hindex">0</div></div>
                </div>
                <div style="flex-grow: 1; border-top: 1px solid ${border}; padding-top: 15px;">
                    <div id="dash-line" style="width: 100%; height: 180px;"></div>
                </div>
            </div>

            <div style="grid-column: 1; grid-row: 2; padding: 0; border-right: 1px solid ${border}; position: relative; height: 100%;">
                <h4 style="position:absolute; top:20px; left:20px; margin: 0; font-size: 0.9rem; color: ${muted}; text-transform: uppercase; z-index:10; pointer-events:none;">Impact Map</h4>
                <div id="knowledge-graph" style="width: 100%; height: 100%;"></div>
            </div>

            <div style="grid-column: 2; grid-row: 2; padding: 25px; display: flex; flex-direction: column; height: 100%;">
                <h4 style="font-size: 0.8rem; color: ${muted}; text-transform: uppercase; margin-bottom: 15px;">Collaboration DNA</h4>
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1; background: ${isDark ? 'rgba(255,255,255,0.05)' : '#f8f9fa'}; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: ${muted}; text-transform: uppercase;">Density</div>
                        <div style="font-size: 1.4rem; font-weight: 800; color: ${text};" id="net-density">0.00</div>
                        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">Network interconnection</div>
                    </div>
                    <div style="flex: 1; background: ${isDark ? 'rgba(255,255,255,0.05)' : '#f8f9fa'}; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: ${muted}; text-transform: uppercase;">Network Cohesion</div>
                        <div style="font-size: 1.4rem; font-weight: 800; color: ${highlight};" id="net-lcc">0%</div>
                        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">Largest component size</div>
                    </div>
                </div>

                <div>
                    <div style="font-size: 0.75rem; color: ${muted}; text-transform: uppercase; margin-bottom: 8px;">Primary Research Clusters</div>
                    <div id="net-clusters" style="font-size: 0.85rem; line-height: 1.6;">
                        <span style="opacity: 0.5;">Analyzing network...</span>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // --- 2. INIT LAYOUT ---
    root.innerHTML = renderLayout();
    
    // --- 3. DATA FETCHING ---
    const safeFetch = (url) => fetch(url).then(r => r.ok ? r.json() : null).catch(e => null);

    Promise.all([
        safeFetch('/data/publications.json'),
        safeFetch('/data/scholar-metrics.json')
    ]).then(([papersData, scholarData]) => {
        
        // --- DATA NORMALIZATION (FIX 3: Prioritize Scholar Data) ---
        let papers = [];

        // We PREFER scholarData.individualPublications because it contains 'citations'
        // publications.json is cleaner but lacks metrics needed for node sizing
        if (scholarData && scholarData.individualPublications) {
            papers = scholarData.individualPublications;
        } 
        else if (papersData) {
            // Fallback (nodes will be small/equal size)
            papers = Array.isArray(papersData) ? papersData : (papersData.individualPublications || []);
        }

        // Render Charts
        if (scholarData) {
            renderRadar(scholarData, papers);
            if (scholarData.citationsByYear) renderLine(scholarData.citationsByYear);
            
            updateText('metric-hindex', scholarData.metrics.hIndex || 0);
            updateText('metric-cites', scholarData.metrics.citations || 0);
            
            let interests = scholarData.metrics.interests || ['AI', 'Cybersecurity'];
            updateText('metric-focus', interests[0] || "Cybersecurity");
            updateText('metric-trend', interests[1] || "AI");
            updateText('metric-velocity', scholarData.metrics.citationVelocity || "-");
        }

        // Render Manuscript Network (Impact Map)
        if (papers.length > 0) {
            renderMap(papers);
        } else {
            document.getElementById('knowledge-graph').innerHTML = '<div style="padding:40px; text-align:center; opacity:0.5">No publication data found.</div>';
        }

    });

    // --- 4. RENDER MANUSCRIPT NETWORK ---
    function renderMap(papers) {
        var dom = document.getElementById('knowledge-graph');
        if (!dom) return;
        
        if (graphChart) graphChart.dispose();
        graphChart = echarts.init(dom);
        var isDark = document.body.classList.contains('dark');

        // --- A. PREPARE DATA ---
        const stopWords = new Set(["the", "and", "of", "in", "on", "for", "with", "a", "an", "to", "at", "by", "from", "up", "about", "into", "over", "after", "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "do", "does", "did", "can", "could", "should", "would", "will", "study", "analysis", "using", "based", "approach", "review", "case", "system", "towards", "via", "framework", "model", "data", "detection"]);

        const getTokens = (str) => {
            if(!str) return [];
            return str.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w.length > 3 && !stopWords.has(w));
        };

        const getAuthors = (p) => {
            let authStr = Array.isArray(p.authors) ? p.authors.join(',') : (p.authors || "");
            return authStr.toLowerCase().split(',').map(a => a.trim()).filter(a => a && !a.includes("ampel"));
        };

        // Create Nodes
        var nodes = papers.map((p, idx) => {
            let val = p.citations || 0; // FIX 4: Safety default
            return {
                id: idx.toString(),
                name: p.title,
                year: p.year,
                venue: p.venue || "Unknown",
                value: val,
                tokens: getTokens(p.title),
                authors: getAuthors(p),
                // FIX 5: Safer Math.log to prevent NaN if citations are missing
                symbolSize: Math.max(5, Math.log(val + 2) * 8),
                itemStyle: { color: isDark ? '#00e5ff' : '#1a0dab' },
                label: { show: (val > 10) }
            };
        });

        // Create Edges
        var links = [];
        var adjList = new Map();

        for (let i = 0; i < nodes.length; i++) {
            if(!adjList.has(i)) adjList.set(i, []);
            
            for (let j = i + 1; j < nodes.length; j++) {
                let nodeA = nodes[i];
                let nodeB = nodes[j];
                let weight = 0;
                let reasons = [];

                let commonWords = nodeA.tokens.filter(x => nodeB.tokens.includes(x));
                if (commonWords.length > 0) { weight += commonWords.length * 1.5; reasons.push("Topic"); }

                let commonAuths = nodeA.authors.filter(x => nodeB.authors.includes(x));
                if (commonAuths.length > 0) { weight += commonAuths.length * 3.0; reasons.push("Authors"); }

                if (nodeA.venue !== "Unknown" && nodeA.venue === nodeB.venue) { weight += 1.0; reasons.push("Venue"); }

                if (weight > 1.0) {
                    links.push({
                        source: i.toString(),
                        target: j.toString(),
                        value: weight,
                        desc: reasons.join(", "),
                        lineStyle: {
                            width: Math.min(weight, 4),
                            opacity: isDark ? 0.3 : 0.2,
                            curveness: 0.2
                        }
                    });
                    adjList.get(i).push(j);
                    if(!adjList.has(j)) adjList.set(j, []);
                    adjList.get(j).push(i);
                }
            }
        }

        // --- B. NETWORK STATS ---
        let n = nodes.length;
        let e = links.length;
        let density = (n > 1) ? (2 * e) / (n * (n - 1)) : 0;
        
        let visited = new Set();
        let maxComp = 0;
        for(let i=0; i<n; i++) {
            if(!visited.has(i)) {
                let size = 0;
                let q = [i];
                visited.add(i);
                while(q.length > 0) {
                    let u = q.shift();
                    size++;
                    let neighbors = adjList.get(u) || [];
                    for(let v of neighbors) {
                        if(!visited.has(v)) { visited.add(v); q.push(v); }
                    }
                }
                if(size > maxComp) maxComp = size;
            }
        }
        let lccPct = (n>0) ? Math.round((maxComp/n)*100) : 0;

        updateText('net-density', density.toFixed(3));
        updateText('net-lcc', lccPct + "%");
        
        let hubs = [...nodes].sort((a,b) => (adjList.get(parseInt(b.id))||[]).length - (adjList.get(parseInt(a.id))||[]).length).slice(0,3);
        let clusterHtml = hubs.map((h, i) => {
            let color = ['#00ff41', '#00e5ff', '#e040fb'][i];
            let safeName = h.name.length > 40 ? h.name.substring(0, 40) + "..." : h.name;
            return `<div style="margin-bottom:8px; padding-left:10px; border-left:3px solid ${color};">
                <strong style="color:inherit; opacity:0.9;">Cluster ${i+1}</strong><br>
                <span style="font-size:0.75em; opacity:0.7;">Centered on "${safeName}"</span>
            </div>`;
        }).join('');
        document.getElementById('net-clusters').innerHTML = clusterHtml;


        // --- C. RENDER GRAPH ---
        var option = {
            tooltip: {
                formatter: (p) => {
                    if (p.dataType === 'edge') return `Linked by: ${p.data.desc}`;
                    return `<div style="max-width:200px; white-space:normal;"><strong>${p.name}</strong><br>${p.data.year} â€¢ ${p.value} Citations</div>`;
                }
            },
            series: [{
                type: 'graph',
                layout: 'force',
                data: nodes,
                links: links,
                roam: true,
                zoom: 0.6,
                label: { position: 'right', color: isDark ? '#ddd' : '#333' },
                lineStyle: { color: isDark ? '#aaa' : '#999' },
                force: {
                    repulsion: 300,
                    gravity: 0.1,
                    edgeLength: [30, 100]
                }
            }]
        };
        graphChart.setOption(option);
    }

    // --- 5. HELPERS ---
    function updateText(id, val) {
        const el = document.getElementById(id);
        if (el) el.innerText = val;
    }

    function renderRadar(data, papers) {
        var dom = document.getElementById('dash-radar');
        if(!dom) return;
        if(radarChart) radarChart.dispose();
        radarChart = echarts.init(dom);
        
        let cats = (data.metrics && data.metrics.interests) ? data.metrics.interests : ['AI', 'Cyber'];
        // Fix: Case insensitive match
        let seriesData = cats.map(c => papers.filter(p => (p.title||"").toLowerCase().includes(c.toLowerCase())).length || 0);
        
        // Normalize for visual balance
        let maxVal = Math.max(...seriesData) || 1;
        
        let isDark = document.body.classList.contains('dark');
        radarChart.setOption({
            radar: { 
                indicator: cats.map((c,i) => ({name:c, max: maxVal + 1})), 
                splitArea:{show:false},
                axisName: {color: isDark ? '#aaa' : '#333'}
            },
            series: [{ type: 'radar', data: [{value: seriesData}], itemStyle: {color: isDark?'#00ff41':'#d93025'}, areaStyle:{opacity:0.2} }]
        });
    }

    function renderLine(history) {
        var dom = document.getElementById('dash-line');
        if(!dom) return;
        if(lineChart) lineChart.dispose();
        lineChart = echarts.init(dom);
        let isDark = document.body.classList.contains('dark');
        lineChart.setOption({
            grid: {top:10, bottom:20, right:10, left:30},
            xAxis: {type:'category', data: history.map(h=>h.year), axisLine:{show:false}, axisLabel:{color: isDark ? '#aaa' : '#666'}},
            yAxis: {type:'value', splitLine:{show:false}, axisLabel:{color: isDark ? '#aaa' : '#666'}},
            series: [{type:'bar', data: history.map(h=>h.citations), itemStyle:{color: isDark?'#00e5ff':'#1a0dab', borderRadius:[2,2,0,0]}}]
        });
    }

    window.addEventListener('resize', function() {
        if(graphChart) graphChart.resize();
        if(radarChart) radarChart.resize();
        if(lineChart) lineChart.resize();
    });

})();
</script>
