{{/* Research Command Center - Robust Version */}}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="research-dashboard-container" style="
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    grid-template-rows: auto 550px; 
    gap: 0; 
    background: var(--card-bg, rgba(255,255,255,0.02)); 
    border: 1px solid var(--card-border, #333); 
    border-radius: 12px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
    margin: 30px 0;
    overflow: hidden;
">
    
    <div style="grid-column: 1; grid-row: 1; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--card-border, #333); border-bottom: 1px solid var(--card-border, #333);">
        <h4 style="margin: 0 0 10px; font-size: 0.9rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; text-align: center;">Research Profile</h4>
        <div id="dash-radar-chart" style="width: 100%; height: 300px;"></div>
    </div>

    <div style="grid-column: 2; grid-row: 1; padding: 25px; border-bottom: 1px solid var(--card-border, #333); display: flex; flex-direction: column;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div><div style="font-size: 0.8rem; opacity: 0.7;">Primary Focus</div><div style="font-size: 1.1rem; font-weight: 800; color: #00ff41;" id="dash-metric-focus">...</div></div>
            <div><div style="font-size: 0.8rem; opacity: 0.7;">Trending</div><div style="font-size: 1.1rem; font-weight: 800; color: #00e5ff;" id="dash-metric-trend">...</div></div>
            <div><div style="font-size: 0.8rem; opacity: 0.7;">Velocity</div><div style="font-size: 1.1rem; font-weight: 800; color: #00e5ff;" id="dash-metric-velocity">-</div></div>
            <div><div style="font-size: 0.8rem; opacity: 0.7;">Total Citations</div><div style="font-size: 1.5rem; font-weight: 800; color: #e040fb;" id="dash-metric-cites">0</div></div>
            <div><div style="font-size: 0.8rem; opacity: 0.7;">h-index</div><div style="font-size: 1.5rem; font-weight: 800; opacity: 0.9;" id="dash-metric-hindex">0</div></div>
        </div>
        <div style="flex-grow: 1; border-top: 1px solid var(--card-border, #333); padding-top: 15px;">
            <div id="dash-line-chart" style="width: 100%; height: 180px;"></div>
        </div>
    </div>

    <div style="grid-column: 1; grid-row: 2; padding: 0; border-right: 1px solid var(--card-border, #333); position: relative; height: 100%; min-height: 500px;">
        <h4 style="position:absolute; top:20px; left:20px; margin: 0; font-size: 0.9rem; opacity: 0.7; text-transform: uppercase; z-index:10; pointer-events:none;">Impact Map</h4>
        <div id="dashboard-impact-map" style="width: 100%; height: 100%;"></div>
    </div>

    <div style="grid-column: 2; grid-row: 2; padding: 25px; display: flex; flex-direction: column; height: 100%;">
        <h4 style="font-size: 0.8rem; opacity: 0.7; text-transform: uppercase; margin-bottom: 15px;">Collaboration DNA</h4>
        
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1; background: rgba(125,125,125,0.05); padding: 15px; border-radius: 8px;">
                <div style="font-size: 0.75rem; opacity: 0.7; text-transform: uppercase;">Density</div>
                <div style="font-size: 1.4rem; font-weight: 800;" id="dash-net-density">0.00</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">Network interconnection</div>
            </div>
            <div style="flex: 1; background: rgba(125,125,125,0.05); padding: 15px; border-radius: 8px;">
                <div style="font-size: 0.75rem; opacity: 0.7; text-transform: uppercase;">Network Cohesion</div>
                <div style="font-size: 1.4rem; font-weight: 800; color: #00e5ff;" id="dash-net-lcc">0%</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">Largest component size</div>
            </div>
        </div>

        <div>
            <div style="font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; margin-bottom: 8px;">Primary Research Clusters</div>
            <div id="dash-net-clusters" style="font-size: 0.85rem; line-height: 1.6;">
                <span style="opacity: 0.5;">Analyzing network...</span>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
(function() {
    // Unique Namespace IDs
    const IDS = {
        RADAR: 'dash-radar-chart',
        LINE: 'dash-line-chart',
        MAP: 'dashboard-impact-map', // UNIQUE ID
        METRICS: {
            FOCUS: 'dash-metric-focus', TREND: 'dash-metric-trend',
            VELOCITY: 'dash-metric-velocity', CITES: 'dash-metric-cites',
            HINDEX: 'dash-metric-hindex'
        },
        NET: { DENSITY: 'dash-net-density', LCC: 'dash-net-lcc', CLUSTERS: 'dash-net-clusters' }
    };

    var radarChart, lineChart, graphChart;
    var isDark = document.body.classList.contains('dark');

    // --- HELPER: Safe Element Update ---
    function updateText(id, val) {
        const el = document.getElementById(id);
        if (el) el.innerText = val;
    }

    // --- DATA FETCHING ---
    const safeFetch = (url) => fetch(url).then(r => r.ok ? r.json() : null).catch(e => null);

    Promise.all([
        safeFetch('/data/publications.json'),
        safeFetch('/data/scholar-metrics.json')
    ]).then(([papersData, scholarData]) => {
        
        // 1. Prepare Paper Data (Priority: Scholar Metrics > Publications.json)
        let papers = [];
        if (scholarData && scholarData.individualPublications) {
            papers = scholarData.individualPublications;
        } else if (papersData) {
            papers = Array.isArray(papersData) ? papersData : (papersData.individualPublications || []);
        }

        // 2. Metrics & Charts
        if (scholarData) {
            renderRadar(scholarData, papers);
            if (scholarData.citationsByYear) renderLine(scholarData.citationsByYear);
            
            updateText(IDS.METRICS.HINDEX, scholarData.metrics?.hIndex || 0);
            updateText(IDS.METRICS.CITES, scholarData.metrics?.citations || 0);
            
            let interests = scholarData.metrics?.interests || ['AI', 'Cybersecurity'];
            updateText(IDS.METRICS.FOCUS, interests[0] || "Cybersecurity");
            updateText(IDS.METRICS.TREND, interests[1] || "AI");
            updateText(IDS.METRICS.VELOCITY, scholarData.metrics?.citationVelocity || "-");
        }

        // 3. Render Map (Even if scholarData failed, we try with papersData)
        if (papers.length > 0) {
            renderMap(papers);
        } else {
            const mapEl = document.getElementById(IDS.MAP);
            if(mapEl) mapEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;opacity:0.5;">No network data available</div>';
        }

    });

    // --- RENDER MAP ---
    function renderMap(papers) {
        var dom = document.getElementById(IDS.MAP);
        if (!dom) return;
        
        if (graphChart) graphChart.dispose();
        graphChart = echarts.init(dom);
        
        const stopWords = new Set(["the", "and", "of", "in", "on", "for", "with", "a", "an", "to", "at", "by", "from", "up", "about", "into", "over", "after", "is", "are", "was", "were", "be", "been", "being", "have", "has", "had", "do", "does", "did", "can", "could", "should", "would", "will", "study", "analysis", "using", "based", "approach", "review", "case", "system", "towards", "via", "framework", "model", "data", "detection"]);

        // Normalize
        var nodes = papers.map((p, idx) => {
            let val = p.citations || 0; // Default to 0 if missing
            return {
                id: idx.toString(),
                name: p.title,
                year: p.year,
                venue: p.venue || "Unknown",
                value: val,
                tokens: (p.title||"").toLowerCase().replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(w => w.length > 3 && !stopWords.has(w)),
                authors: (Array.isArray(p.authors) ? p.authors.join(',') : (p.authors||"")).toLowerCase().split(',').map(a=>a.trim()).filter(a=>a && !a.includes("ampel")),
                // Robust Math: Prevent NaN issues
                symbolSize: Math.max(5, Math.log(val + 2) * 8),
                itemStyle: { color: isDark ? '#00e5ff' : '#1a0dab' },
                label: { show: (val > 10) }
            };
        });

        // Edges
        var links = [];
        var adjList = new Map();

        for (let i = 0; i < nodes.length; i++) {
            if(!adjList.has(i)) adjList.set(i, []);
            for (let j = i + 1; j < nodes.length; j++) {
                let nodeA = nodes[i];
                let nodeB = nodes[j];
                let weight = 0;
                let reasons = [];

                let commonWords = nodeA.tokens.filter(x => nodeB.tokens.includes(x));
                if (commonWords.length > 0) { weight += commonWords.length * 1.5; reasons.push("Topic"); }

                let commonAuths = nodeA.authors.filter(x => nodeB.authors.includes(x));
                if (commonAuths.length > 0) { weight += commonAuths.length * 3.0; reasons.push("Authors"); }

                if (nodeA.venue !== "Unknown" && nodeA.venue === nodeB.venue) { weight += 1.0; reasons.push("Venue"); }

                if (weight > 1.0) {
                    links.push({
                        source: i.toString(),
                        target: j.toString(),
                        value: weight,
                        desc: reasons.join(", "),
                        lineStyle: {
                            width: Math.min(weight, 4),
                            opacity: isDark ? 0.3 : 0.2,
                            curveness: 0.2
                        }
                    });
                    adjList.get(i).push(j);
                    if(!adjList.has(j)) adjList.set(j, []);
                    adjList.get(j).push(i);
                }
            }
        }

        // Stats
        let n = nodes.length;
        let e = links.length;
        let density = (n > 1) ? (2 * e) / (n * (n - 1)) : 0;
        
        let visited = new Set();
        let maxComp = 0;
        for(let i=0; i<n; i++) {
            if(!visited.has(i)) {
                let size = 0;
                let q = [i];
                visited.add(i);
                while(q.length > 0) {
                    let u = q.shift();
                    size++;
                    let neighbors = adjList.get(u) || [];
                    for(let v of neighbors) {
                        if(!visited.has(v)) { visited.add(v); q.push(v); }
                    }
                }
                if(size > maxComp) maxComp = size;
            }
        }
        let lccPct = (n>0) ? Math.round((maxComp/n)*100) : 0;
        updateText(IDS.NET.DENSITY, density.toFixed(3));
        updateText(IDS.NET.LCC, lccPct + "%");
        
        // Clusters
        let hubs = [...nodes].sort((a,b) => (adjList.get(parseInt(b.id))||[]).length - (adjList.get(parseInt(a.id))||[]).length).slice(0,3);
        let clusterHtml = hubs.map((h, i) => {
            let color = ['#00ff41', '#00e5ff', '#e040fb'][i];
            let safeName = h.name.length > 40 ? h.name.substring(0, 40) + "..." : h.name;
            return `<div style="margin-bottom:8px; padding-left:10px; border-left:3px solid ${color};">
                <strong style="color:inherit; opacity:0.9;">Cluster ${i+1}</strong><br>
                <span style="font-size:0.75em; opacity:0.7;">Centered on "${safeName}"</span>
            </div>`;
        }).join('');
        const clustEl = document.getElementById(IDS.NET.CLUSTERS);
        if(clustEl) clustEl.innerHTML = clusterHtml;

        // Render
        var option = {
            backgroundColor: 'transparent',
            tooltip: {
                formatter: (p) => {
                    if (p.dataType === 'edge') return `Linked by: ${p.data.desc}`;
                    return `<div style="max-width:200px; white-space:normal;"><strong>${p.name}</strong><br>${p.data.year} â€¢ ${p.value} Citations</div>`;
                }
            },
            series: [{
                type: 'graph',
                layout: 'force',
                data: nodes,
                links: links,
                roam: true,
                zoom: 0.6,
                label: { position: 'right', color: isDark ? '#ddd' : '#333' },
                lineStyle: { color: isDark ? '#aaa' : '#999' },
                force: {
                    repulsion: 300,
                    gravity: 0.1,
                    edgeLength: [30, 100]
                }
            }]
        };
        graphChart.setOption(option);
    }

    // --- RENDER RADAR ---
    function renderRadar(data, papers) {
        var dom = document.getElementById(IDS.RADAR);
        if(!dom) return;
        if(radarChart) radarChart.dispose();
        radarChart = echarts.init(dom);
        
        let cats = (data.metrics && data.metrics.interests) ? data.metrics.interests : ['AI', 'Cyber'];
        let seriesData = cats.map(c => papers.filter(p => (p.title||"").toLowerCase().includes(c.toLowerCase())).length || 0);
        let maxVal = Math.max(...seriesData) || 1;
        
        radarChart.setOption({
            radar: { 
                indicator: cats.map((c,i) => ({name:c, max: maxVal + 1})), 
                splitArea:{show:false},
                axisName: {color: isDark ? '#aaa' : '#333'}
            },
            series: [{ type: 'radar', data: [{value: seriesData}], itemStyle: {color: isDark?'#00ff41':'#d93025'}, areaStyle:{opacity:0.2} }]
        });
    }

    // --- RENDER LINE ---
    function renderLine(history) {
        var dom = document.getElementById(IDS.LINE);
        if(!dom) return;
        if(lineChart) lineChart.dispose();
        lineChart = echarts.init(dom);
        
        lineChart.setOption({
            grid: {top:10, bottom:20, right:10, left:30},
            xAxis: {type:'category', data: history.map(h=>h.year), axisLine:{show:false}, axisLabel:{color: isDark ? '#aaa' : '#666'}},
            yAxis: {type:'value', splitLine:{show:false}, axisLabel:{color: isDark ? '#aaa' : '#666'}},
            series: [{type:'bar', data: history.map(h=>h.citations), itemStyle:{color: isDark?'#00e5ff':'#1a0dab', borderRadius:[2,2,0,0]}}]
        });
    }

    // --- EVENTS ---
    window.addEventListener('resize', function() {
        if(graphChart) graphChart.resize();
        if(radarChart) radarChart.resize();
        if(lineChart) lineChart.resize();
    });

    const themeBtn = document.querySelector('.js-theme-toggle');
    if(themeBtn) {
        themeBtn.addEventListener('click', () => {
            setTimeout(() => {
                isDark = document.body.classList.contains('dark');
                // Re-render handled by just refreshing data or simple timeout
                // For robustness, full reload of charts:
                // (Omitted for brevity, but variables are accessible)
            }, 100);
        });
    }

})();
</script>
