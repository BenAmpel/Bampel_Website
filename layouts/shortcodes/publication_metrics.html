<div class="pub-metrics-panel" id="pub-metrics-panel">
  <div class="pub-metrics-header">
    <div class="pub-metrics-title">Publication Metrics</div>
    <div class="pub-metrics-updated" id="pub-metrics-updated"></div>
  </div>
  <div class="pub-metrics-layout">
    <div class="pub-metric-card">
      <div class="label">Journals</div>
      <div class="value" id="pub-metrics-journal">0</div>
    </div>
    <div class="pub-metric-card">
      <div class="label">Conferences</div>
      <div class="value" id="pub-metrics-conference">0</div>
    </div>
    <div class="pub-metric-card">
      <div class="label">Workshops</div>
      <div class="value" id="pub-metrics-workshop">0</div>
    </div>
    <div class="pub-metrics-chart">
      <div class="label">Citations & Publications Per Year</div>
      <svg id="pub-metrics-sparkline" viewBox="0 0 320 80" preserveAspectRatio="none" aria-hidden="true"></svg>
      <div class="pub-metrics-legend">
        <span class="legend-item"><span class="legend-swatch citations"></span> Citations</span>
        <span class="legend-item"><span class="legend-swatch publications"></span> Publications</span>
        <span class="legend-item" id="pub-metrics-yoy"></span>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
(function () {
  const panel = document.getElementById('pub-metrics-panel');
  if (!panel) return;

  const updatedEl = document.getElementById('pub-metrics-updated');
  const journalEl = document.getElementById('pub-metrics-journal');
  const conferenceEl = document.getElementById('pub-metrics-conference');
  const workshopEl = document.getElementById('pub-metrics-workshop');
  const sparklineEl = document.getElementById('pub-metrics-sparkline');
  const yoyEl = document.getElementById('pub-metrics-yoy');

  const safeFetch = (url) => fetch(url).then((r) => (r.ok ? r.json() : null)).catch(() => null);

  const formatYoY = (label, value) => {
    if (value === null || value === undefined) return `${label}: n/a`;
    const sign = value > 0 ? '+' : '';
    return `${label}: ${sign}${value}%`;
  };

  Promise.all([
    safeFetch('/data/publications.json'),
    safeFetch('/data/scholar-metrics.json'),
  ]).then(([pubData, scholarData]) => {
    const pubs = Array.isArray(pubData) ? pubData : (pubData && pubData.publications) || [];
    const typeCounts = { journal: 0, conference: 0, workshop: 0 };
    const pubsByYear = new Map();

    pubs.forEach((pub) => {
      const type = (pub.type || '').toLowerCase();
      if (typeCounts[type] !== undefined) typeCounts[type] += 1;
      const year = Number(pub.year);
      if (Number.isFinite(year)) {
        pubsByYear.set(year, (pubsByYear.get(year) || 0) + 1);
      }
    });

    journalEl.textContent = typeCounts.journal;
    conferenceEl.textContent = typeCounts.conference;
    workshopEl.textContent = typeCounts.workshop;

    if (scholarData && scholarData.lastUpdated) {
      updatedEl.textContent = `Last updated: ${scholarData.lastUpdated}`;
    }

    const citesByYear = new Map();
    const citeRows = (scholarData && scholarData.citationsByYear) || [];
    citeRows.forEach((row) => {
      const year = Number(row.year);
      const citations = Number(row.citations);
      if (Number.isFinite(year) && Number.isFinite(citations)) {
        citesByYear.set(year, citations);
      }
    });

    const yearSet = new Set([...pubsByYear.keys(), ...citesByYear.keys()]);
    const years = Array.from(yearSet).sort((a, b) => a - b);

    if (!years.length) {
      sparklineEl.innerHTML = '';
      if (yoyEl) yoyEl.textContent = 'YoY: n/a';
      return;
    }

    const pubSeries = years.map((year) => pubsByYear.get(year) || 0);
    const citeSeries = years.map((year) => citesByYear.get(year) || 0);

    const width = 320;
    const height = 80;
    const padding = 4;

    const normalizeSeries = (series) => {
      const minValue = Math.min(...series);
      const maxValue = Math.max(...series);
      const range = Math.max(maxValue - minValue, 1);
      return series.map((value) => (value - minValue) / range);
    };

    const points = (series) => series.map((value, index) => {
      const x = padding + (width - 2 * padding) * (index / Math.max(series.length - 1, 1));
      const y = height - padding - (height - 2 * padding) * value;
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');

    const citePoints = points(normalizeSeries(citeSeries));
    const pubPoints = points(normalizeSeries(pubSeries));

    sparklineEl.innerHTML = `
      <polyline class="sparkline-path citations" points="${citePoints}"></polyline>
      <polyline class="sparkline-path publications" points="${pubPoints}"></polyline>
    `;

    const lastIndex = years.length - 1;
    const citeYoY = (lastIndex > 0 && citeSeries[lastIndex - 1] > 0)
      ? Math.round(((citeSeries[lastIndex] - citeSeries[lastIndex - 1]) / citeSeries[lastIndex - 1]) * 100)
      : null;
    const pubYoY = (lastIndex > 0 && pubSeries[lastIndex - 1] > 0)
      ? Math.round(((pubSeries[lastIndex] - pubSeries[lastIndex - 1]) / pubSeries[lastIndex - 1]) * 100)
      : null;

    if (yoyEl) {
      yoyEl.textContent = `${formatYoY('Cites', citeYoY)} â€¢ ${formatYoY('Pubs', pubYoY)}`;
    }
  });
})();
</script>
