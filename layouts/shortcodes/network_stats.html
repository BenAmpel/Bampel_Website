{{/* Network Statistics - Safe Injection Method */}}
<div id="stats-root" style="min-height: 120px;"></div>

<script>
(function() {
    var root = document.getElementById('stats-root');
    var myName = "Benjamin Ampel"; // Your name for filtering

    // 1. DYNAMIC HTML GENERATOR
    // We build the HTML inside JS to prevent Hugo from displaying raw tags
    function renderLayout() {
        var isDark = document.body.classList.contains('dark');
        var bg = isDark ? 'rgba(255,255,255,0.05)' : '#ffffff';
        var border = isDark ? '#333' : '#eee';
        var text = isDark ? '#aaa' : '#666';
        
        return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; opacity: 0; transition: opacity 1s ease;" id="stats-grid">
            <div style="background: ${bg}; padding: 20px; border-radius: 8px; border: 1px solid ${border}; text-align: center;">
                <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: ${isDark ? '#00ff41' : '#d93025'};">
                    <span id="val-collab">0</span>
                </h3>
                <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: ${text};">Unique Collaborators</p>
            </div>

            <div style="background: ${bg}; padding: 20px; border-radius: 8px; border: 1px solid ${border}; text-align: center;">
                <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: ${isDark ? '#00e5ff' : '#1a0dab'};">
                    <span id="val-team">0</span>
                </h3>
                <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: ${text};">Avg. Authors / Paper</p>
            </div>

            <div style="background: ${bg}; padding: 20px; border-radius: 8px; border: 1px solid ${border}; text-align: center;">
                <h3 id="val-top" style="margin: 0; font-size: 1.5rem; font-weight: 800; color: ${isDark ? '#e040fb' : '#9c27b0'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 3rem;">
                    -
                </h3>
                <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: ${text};">Top Collaborator</p>
            </div>

            <div style="background: ${bg}; padding: 20px; border-radius: 8px; border: 1px solid ${border}; text-align: center;">
                <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: ${isDark ? '#ffb74d' : '#ef6c00'};">
                    <span id="val-inst">0</span>
                </h3>
                <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: ${text};">Institutions</p>
            </div>

            <div style="background: ${bg}; padding: 20px; border-radius: 8px; border: 1px solid ${border}; text-align: center;">
                <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: ${isDark ? '#64b5f6' : '#1976d2'};">
                    <span id="val-country">0</span>
                </h3>
                <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: ${text};">Countries</p>
            </div>

            <div style="background: ${bg}; padding: 20px; border-radius: 8px; border: 1px solid ${border}; text-align: center;">
                <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: ${isDark ? '#81c784' : '#2e7d32'};">
                    <span id="val-cross">0</span>
                </h3>
                <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: ${text};">Cross-Disciplinary Papers</p>
            </div>
        </div>`;
    }

    // 2. DATA PROCESSING
    var nameMap = {
        'B Ampel': 'Benjamin Ampel', 'BM Ampel': 'Benjamin Ampel', 'B. Ampel': 'Benjamin Ampel', 'admin': 'Benjamin Ampel', 'Benjamin M. Ampel': 'Benjamin Ampel',
        'H Chen': 'Hsinchun Chen', 'H. Chen': 'Hsinchun Chen',
        'S Samtani': 'Sagar Samtani', 'S. Samtani': 'Sagar Samtani',
        'S Ullman': 'Steven Ullman', 'S. Ullman': 'Steven Ullman',
        'H Zhu': 'Hongyi Zhu', 'H. Zhu': 'Hongyi Zhu',
        'M Patton': 'Mark Patton', 'M. Patton': 'Mark Patton',
        'B Lazarine': 'Ben Lazarine', 'B. Lazarine': 'Ben Lazarine',
        'T Vahedi': 'Tala Vahedi', 'T. Vahedi': 'Tala Vahedi',
        'K Otto': 'Kaeli Otto', 'K. Otto': 'Kaeli Otto',
        'Y Gao': 'Yang Gao', 'Y. Gao': 'Yang Gao',
        'J Hu': 'James Hu', 'J. Hu': 'James Hu',
        'CH Yang': 'Chi-Heng Yang', 'JF Nunamaker Jr': 'Jay Nunamaker',
        'C Marx': 'Carolin Marx', 'C Dacosta': 'Cade Dacosta',
        'C Zhang': 'Chengjun Zhang', 'M Hashim': 'Matthew Hashim',
        'M Wagner': 'Mason Wagner', 'RY Reyes': 'Raul Reyes',
        'S Yang': 'Shanchieh Yang', 'Y Li': 'Yidong Li', 'Y. Li': 'Yidong Li'
    };
    function normalize(name) { return nameMap[name] || name; }

    // 3. EXECUTION
    // Inject HTML immediately
    root.innerHTML = renderLayout();

    // Fetch Data
    Promise.all([
        fetch('/data/publications.json').then(res => res.json()).catch(() => null),
        fetch('/data/collaboration_meta.json').then(res => res.json()).catch(() => null)
    ])
        .then(([data, meta]) => {
            if(!Array.isArray(data)) return;

            let collaborators = new Set();
            let counts = {};
            let totalAuthors = 0;
            let papers = 0;
            let institutions = new Set();
            let countries = new Set();
            let crossDisciplinary = 0;

            const instMap = new Map((meta?.institutions || []).map(inst => [inst.name, inst]));
            const collabMap = new Map((meta?.collaborators || []).map(c => [normalize(c.name), c]));

            function getInstitution(name) {
                const entry = collabMap.get(name);
                return entry?.institution || null;
            }

            function getCountry(name) {
                const instName = getInstitution(name);
                if (!instName) return null;
                const inst = instMap.get(instName);
                return inst?.country || null;
            }

            function getDiscipline(name) {
                const entry = collabMap.get(name);
                if (entry?.discipline) return entry.discipline;
                const instName = getInstitution(name);
                if (!instName) return null;
                const inst = instMap.get(instName);
                return inst?.discipline || null;
            }

            data.forEach(p => {
                if(!p.authors) return;
                papers++;
                // Get unique authors for this paper (excluding self)
                let auths = [...new Set(p.authors.map(normalize))];
                let coAuths = auths.filter(a => a !== myName);
                
                // Team size is co-authors + you
                totalAuthors += (coAuths.length + 1);

                let disciplines = new Set();

                coAuths.forEach(a => {
                    collaborators.add(a);
                    counts[a] = (counts[a] || 0) + 1;
                });

                auths.forEach(a => {
                    const inst = getInstitution(a);
                    if (inst) institutions.add(inst);
                    const country = getCountry(a);
                    if (country) countries.add(country);
                    const discipline = getDiscipline(a);
                    if (discipline) disciplines.add(discipline);
                });

                if (disciplines.size >= 2) {
                    crossDisciplinary += 1;
                }
            });

            // Update UI
            animateValue("val-collab", 0, collaborators.size, 2000, false);
            
            let avg = papers > 0 ? (totalAuthors / papers).toFixed(1) : 0;
            animateValue("val-team", 0, parseFloat(avg), 2000, true);

            let top = Object.entries(counts).sort((a,b) => b[1] - a[1])[0];
            if(top) document.getElementById('val-top').innerText = top[0];

            animateValue("val-inst", 0, institutions.size, 2000, false);
            animateValue("val-country", 0, countries.size, 2000, false);
            animateValue("val-cross", 0, crossDisciplinary, 2000, false);

            // Fade In
            document.getElementById('stats-grid').style.opacity = '1';
        })
        .catch(e => console.error("Stats Error:", e));

    // Helper: Count Animation
    function animateValue(id, start, end, duration, isFloat) {
        let obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            let val = progress * (end - start) + start;
            obj.innerHTML = isFloat ? val.toFixed(1) : Math.floor(val);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // Theme Toggle Listener (Re-renders HTML to catch new colors)
    const btn = document.querySelector('.js-theme-toggle');
    if(btn) {
        btn.addEventListener('click', () => {
            setTimeout(() => {
                // Save current values
                let c = document.getElementById('val-collab').innerText;
                let t = document.getElementById('val-team').innerText;
                let p = document.getElementById('val-top').innerText;
                let i = document.getElementById('val-inst').innerText;
                let o = document.getElementById('val-country').innerText;
                let x = document.getElementById('val-cross').innerText;
                
                // Re-render layout with new theme colors
                root.innerHTML = renderLayout();
                
                // Restore values & Force Visible
                document.getElementById('val-collab').innerText = c;
                document.getElementById('val-team').innerText = t;
                document.getElementById('val-top').innerText = p;
                document.getElementById('val-inst').innerText = i;
                document.getElementById('val-country').innerText = o;
                document.getElementById('val-cross').innerText = x;
                document.getElementById('stats-grid').style.opacity = '1';
            }, 100);
        });
    }
})();
</script>
