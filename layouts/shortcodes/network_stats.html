{{/* Network Statistics - Usage: {{< network_stats >}} */}}

<div id="network-stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; opacity: 0; transition: opacity 1s ease;">
    
    <div class="stat-card" style="background: var(--card-bg, #ffffff); padding: 20px; border-radius: 8px; border: 1px solid var(--card-border, #eee); text-align: center;">
        <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: var(--primary, #d93025);">
            <span id="stat-collaborators">0</span>
        </h3>
        <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #666);">Unique Collaborators</p>
    </div>

    <div class="stat-card" style="background: var(--card-bg, #ffffff); padding: 20px; border-radius: 8px; border: 1px solid var(--card-border, #eee); text-align: center;">
        <h3 style="margin: 0; font-size: 3rem; font-weight: 800; color: var(--secondary, #1a0dab);">
            <span id="stat-team-size">0</span>
        </h3>
        <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #666);">Avg. Authors / Paper</p>
    </div>

    <div class="stat-card" style="background: var(--card-bg, #ffffff); padding: 20px; border-radius: 8px; border: 1px solid var(--card-border, #eee); text-align: center;">
        <h3 id="stat-top-collab" style="margin: 0; font-size: 1.5rem; font-weight: 800; color: var(--accent, #9c27b0); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 3rem;">
            -
        </h3>
        <p style="margin: 5px 0 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #666);">Top Collaborator</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. CONFIGURATION
    var myName = "Benjamin Ampel";
    
    // Comprehensive Name Map (Must match Graph)
    var nameMap = {
        'B Ampel': 'Benjamin Ampel', 'BM Ampel': 'Benjamin Ampel', 'B. Ampel': 'Benjamin Ampel', 'admin': 'Benjamin Ampel',
        'H Chen': 'Hsinchun Chen', 'H. Chen': 'Hsinchun Chen',
        'S Samtani': 'Sagar Samtani', 'S. Samtani': 'Sagar Samtani',
        'S Ullman': 'Steven Ullman', 'S. Ullman': 'Steven Ullman',
        'H Zhu': 'Hongyi Zhu', 'H. Zhu': 'Hongyi Zhu',
        'M Patton': 'Mark Patton', 'M. Patton': 'Mark Patton',
        'B Lazarine': 'Ben Lazarine', 'B. Lazarine': 'Ben Lazarine',
        'T Vahedi': 'Tala Vahedi', 'T. Vahedi': 'Tala Vahedi',
        'K Otto': 'Kaeli Otto', 'K. Otto': 'Kaeli Otto',
        'Y Gao': 'Yang Gao', 'Y. Gao': 'Yang Gao',
        'J Hu': 'James Hu', 'J. Hu': 'James Hu',
        'CH Yang': 'Chi-Heng Yang', 'JF Nunamaker Jr': 'Jay Nunamaker',
        'C Marx': 'Carolin Marx', 'C Dacosta': 'Cade Dacosta',
        'C Zhang': 'Chengjun Zhang', 'M Hashim': 'Matthew Hashim',
        'M Wagner': 'Mason Wagner', 'RY Reyes': 'Raul Reyes',
        'S Yang': 'Shanchieh Yang', 'Y Li': 'Yidong Li', 'Y. Li': 'Yidong Li'
    };

    function normalize(name) { return nameMap[name] || name; }

    // 2. THEME HANDLING
    function updateTheme() {
        const isDark = document.body.classList.contains('dark');
        const root = document.documentElement;
        
        // Set CSS Variables dynamically
        root.style.setProperty('--card-bg', isDark ? 'rgba(255,255,255,0.05)' : '#ffffff');
        root.style.setProperty('--card-border', isDark ? '#333' : '#eee');
        root.style.setProperty('--text-muted', isDark ? '#aaa' : '#666');
        root.style.setProperty('--primary', isDark ? '#00ff41' : '#d93025');   
        root.style.setProperty('--secondary', isDark ? '#00e5ff' : '#1a0dab'); 
        root.style.setProperty('--accent', isDark ? '#e040fb' : '#9c27b0');    
    }

    // 3. MAIN LOGIC
    fetch('/data/publications.json')
        .then(response => {
            if (!response.ok) throw new Error("HTTP error " + response.status);
            return response.json();
        })
        .then(data => {
            if (!Array.isArray(data)) throw new Error("Data is not an array");
            calculateStats(data);
        })
        .catch(err => {
            console.error("Network Stats Error:", err);
            // Force visibility even on error so it doesn't look broken
            var container = document.getElementById('network-stats-container');
            if(container) container.style.opacity = '1';
        });

    function calculateStats(papers) {
        let uniqueCollaborators = new Set();
        let authorCounts = {};
        let totalAuthors = 0;
        let paperCount = 0;

        papers.forEach(paper => {
            if (!paper.authors || !Array.isArray(paper.authors)) return;
            paperCount++;
            
            // Normalize and exclude yourself
            let coAuthors = paper.authors
                .map(normalize)
                .filter(a => a !== myName);
            
            // Deduplicate co-authors per paper
            let uniquePaperAuthors = [...new Set(coAuthors)]; 
            
            // Team Size = Unique Co-Authors + You (1)
            totalAuthors += (uniquePaperAuthors.length + 1); 
            
            // Tally global stats
            uniquePaperAuthors.forEach(a => {
                uniqueCollaborators.add(a);
                authorCounts[a] = (authorCounts[a] || 0) + 1;
            });
        });

        // Update DOM
        animateValue("stat-collaborators", 0, uniqueCollaborators.size, 2000, false);
        
        let avgTeam = paperCount > 0 ? (totalAuthors / paperCount).toFixed(1) : "0";
        animateValue("stat-team-size", 0, parseFloat(avgTeam), 2000, true);

        // Find Top Collaborator
        let entries = Object.entries(authorCounts);
        if (entries.length > 0) {
            // Sort by count (descending)
            entries.sort((a, b) => b[1] - a[1]);
            let topName = entries[0][0];
            let topEl = document.getElementById('stat-top-collab');
            if(topEl) topEl.innerText = topName;
        } else {
            let topEl = document.getElementById('stat-top-collab');
            if(topEl) topEl.innerText = "None";
        }

        // Reveal
        var container = document.getElementById('network-stats-container');
        if(container) container.style.opacity = '1';
    }

    function animateValue(id, start, end, duration, isFloat) {
        let obj = document.getElementById(id);
        if (!obj) return;
        
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            let val = progress * (end - start) + start;
            
            obj.innerHTML = isFloat ? val.toFixed(1) : Math.floor(val);
            
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // Initialize
    updateTheme();
    
    // Theme Switch Listener
    const themeButton = document.querySelector('.js-theme-toggle');
    if(themeButton){
        themeButton.addEventListener('click', function(){
            setTimeout(updateTheme, 100);
        });
    }
});
</script>
