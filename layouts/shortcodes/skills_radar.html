{{/* Research Intelligence Dashboard - Safe Injection Method */}}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div id="dashboard-root" style="min-height: 450px;"></div>

<script type="text/javascript">
(function() {
    var root = document.getElementById('dashboard-root');

    // --- 1. CONSTRUCT HTML (Bypasses Hugo) ---
    function renderLayout() {
        var isDark = document.body.classList.contains('dark');
        // Theme Colors
        var bg = isDark ? 'rgba(255,255,255,0.02)' : '#ffffff';
        var border = isDark ? '#333' : '#eee';
        var muted = isDark ? '#888' : '#888';
        var text = isDark ? '#aaa' : '#666';
        var shadow = isDark ? 'rgba(0,0,0,0.5)' : 'rgba(0,0,0,0.05)';

        // Highlight Colors
        var cFocus = isDark ? '#00ff41' : '#d93025'; // Green/Red
        var cTrend = isDark ? '#00e5ff' : '#1a0dab'; // Cyan/Blue
        var cVel = isDark ? '#e040fb' : '#9c27b0';   // Purple

        return `
        <div id="research-dashboard" style="display: flex; flex-wrap: wrap; align-items: center; gap: 20px; background: ${bg}; border: 1px solid ${border}; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px ${shadow}; margin: 20px 0;">
            
            <div id="skills-radar" style="flex: 1 1 400px; height: 400px; min-width: 300px;"></div>

            <div id="skills-insights" style="flex: 1 1 250px; padding: 10px;">
                <h4 style="margin-top: 0; font-size: 1.1rem; color: ${muted}; text-transform: uppercase; letter-spacing: 1px;">Research Insights</h4>
                
                <div style="margin-bottom: 25px;">
                    <div style="font-size: 2rem; font-weight: 800; color: ${cFocus};" id="insight-focus">...</div>
                    <div style="font-size: 0.9rem; color: ${text};">Primary Focus</div>
                </div>

                <div style="margin-bottom: 25px;">
                    <div style="font-size: 2rem; font-weight: 800; color: ${cTrend};" id="insight-trend">...</div>
                    <div style="font-size: 0.9rem; color: ${text};">Trending Now</div>
                </div>

                <div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${cVel};" id="insight-velocity">0</div>
                    <div style="font-size: 0.9rem; color: ${text};">Recent Papers (3 Yrs)</div>
                </div>
            </div>
        </div>`;
    }

    // --- 2. INJECT LAYOUT ---
    root.innerHTML = renderLayout();
    
    // --- 3. INIT ECHARTS ---
    var dom = document.getElementById('skills-radar');
    var myChart = echarts.init(dom);

    // --- 4. TAXONOMY ---
    const taxonomy = {
        'AI / Deep Learning': ['Deep Learning', 'Neural', 'Transfer Learning', 'Embedding', 'Machine Learning', 'Artificial Intelligence', 'Adversarial'],
        'Cybersecurity':      ['Cyber', 'Vulnerability', 'Exploit', 'Attack', 'Threat', 'Security', 'Malicious', 'Ransomware', 'Phishing'],
        'LLMs & NLP':         ['Large Language Model', 'LLM', 'Text Analytics', 'NLP', 'Transformer', 'Bert', 'GPT', 'Language Models'],
        'Hacker Communities': ['Hacker', 'Forum', 'Dark Web', 'Paste', 'Community', 'Marketplace', 'Underground'],
        'Design Science':     ['Design Science', 'Framework', 'Artifact', 'System', 'Implementation', 'Prototyping'],
        'Behavioral':         ['Nudging', 'Bias', 'Social', 'Human', 'Behavior', 'Psychology', 'Decision', 'Trust']
    };

    // --- 5. FETCH & PROCESS ---
    fetch('/data/publications.json')
        .then(res => res.json())
        .then(papers => {
            if(!Array.isArray(papers)) return;

            // A. All-Time Scores
            let allTimeCounts = countKeywords(papers);
            let dataset = normalizeScores(allTimeCounts);
            
            // B. Trending (Recent)
            let currentYear = new Date().getFullYear();
            let recentPapers = papers.filter(p => p.year >= (currentYear - 2)); 
            let recentCounts = countKeywords(recentPapers);
            
            // C. Populate UI
            populateInsights(allTimeCounts, recentCounts, recentPapers.length);
            renderChart(dataset);
        })
        .catch(err => console.error("Radar Error:", err));

    function countKeywords(paperList) {
        let counts = {};
        Object.keys(taxonomy).forEach(k => counts[k] = 0);
        paperList.forEach(p => {
            let text = (p.title || "").toLowerCase();
            Object.keys(taxonomy).forEach(category => {
                let hit = taxonomy[category].some(k => text.includes(k.toLowerCase()));
                if (hit) counts[category]++;
            });
        });
        return counts;
    }

    function normalizeScores(counts) {
        let maxVal = Math.max(...Object.values(counts)) || 1;
        return Object.keys(taxonomy).map(key => ({
            name: key,
            max: 100,
            value: Math.min(Math.round((counts[key] / maxVal) * 90) + 10, 100)
        }));
    }

    function populateInsights(allTime, recent, recentCount) {
        // Find best category (sort descending)
        let topSkill = Object.entries(allTime).sort((a,b) => b[1] - a[1])[0][0];
        let trendSkill = Object.entries(recent).sort((a,b) => b[1] - a[1])[0][0];
        
        document.getElementById('insight-focus').innerText = topSkill;
        document.getElementById('insight-trend').innerText = trendSkill;
        document.getElementById('insight-velocity').innerText = recentCount;
    }

    function renderChart(data) {
        function getOption(isDark) {
            var primary = isDark ? '#00ff41' : '#d93025';
            var text = isDark ? '#eee' : '#333';
            var split = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            return {
                backgroundColor: 'transparent',
                radar: {
                    indicator: data.map(d => ({ name: d.name, max: 100 })),
                    shape: 'circle',
                    splitNumber: 4,
                    radius: '65%',
                    axisName: { color: text, fontWeight: 'bold', fontSize: 11 },
                    splitLine: { lineStyle: { color: split } },
                    splitArea: { show: false },
                    axisLine: { lineStyle: { color: isDark ? '#444' : '#ccc' } }
                },
                series: [{
                    type: 'radar',
                    data: [{
                        value: data.map(d => d.value),
                        name: 'Profile',
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: primary },
                        lineStyle: { width: 3, color: primary },
                        areaStyle: { 
                            color: new echarts.graphic.RadialGradient(0.5, 0.5, 1, [
                                { offset: 0, color: primary + '10' }, 
                                { offset: 1, color: primary + '60' }
                            ])
                        }
                    }]
                }]
            };
        }

        let isDark = document.body.classList.contains('dark');
        myChart.setOption(getOption(isDark));
        window.addEventListener('resize', () => myChart.resize());

        // Theme Toggle Listener
        const btn = document.querySelector('.js-theme-toggle');
        if(btn){
            btn.addEventListener('click', () => {
                setTimeout(() => {
                    // Re-inject HTML to update CSS variables/colors
                    var oldFocus = document.getElementById('insight-focus').innerText;
                    var oldTrend = document.getElementById('insight-trend').innerText;
                    var oldVel = document.getElementById('insight-velocity').innerText;

                    root.innerHTML = renderLayout(); // Re-render HTML container
                    
                    // Restore values
                    document.getElementById('insight-focus').innerText = oldFocus;
                    document.getElementById('insight-trend').innerText = oldTrend;
                    document.getElementById('insight-velocity').innerText = oldVel;

                    // Re-init chart in new container
                    dom = document.getElementById('skills-radar');
                    myChart = echarts.init(dom);
                    let isDarkNow = document.body.classList.contains('dark');
                    myChart.setOption(getOption(isDarkNow));
                }, 100);
            });
        }
    }
})();
</script>
