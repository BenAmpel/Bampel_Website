{{/* Interactive Research Network - Usage: {{< research_network >}} */}}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

{{ $seed := "abcdefghijklmnopqrstuvwxyz" }}
{{ $uniqueID := delimit (shuffle (split $seed "")) "" }}
<div id="network-{{ $uniqueID }}" style="width: 100%; min-height: 700px; height: 700px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative;"></div>

<script type="text/javascript">
(function() {
    var domID = "network-{{ $uniqueID }}";
    // Ingest Data from Hugo
    var rawNodes = {{ .Site.Data.network.nodes | jsonify }};
    var rawLinks = {{ .Site.Data.network.links | jsonify }};
    
    document.addEventListener('DOMContentLoaded', function() {
        var dom = document.getElementById(domID);
        if (!dom) return;

        // 1. SETUP ECHARTS
        var myChart = echarts.init(dom);
        var hasRendered = false;
        
        // Prepare Data (convert category string to index)
        var nodes = rawNodes.map(node => ({
            id: node.id,
            name: node.name,
            symbolSize: node.size,
            category: catMap[node.group] !== undefined ? catMap[node.group] : 3, // Default to collaborator
            group: node.group, // Keep original for logic checks
            fixed: node.group === 'self' ? true : false,
            x: node.group === 'self' ? 500 : null,
            y: node.group === 'self' ? 300 : null
        }));

        // 2. DEFINE CATEGORIES & BUILD LOOKUP MAP
        var categories = [
            { name: 'self' },        // 0
            { name: 'advisor' },     // 1
            { name: 'professor' },   // 2
            { name: 'collaborator' }, // 3
            { name: 'student' }      // 4
        ];
        
        // Map category names to indices (ECharts requires numeric category)
        var catMap = {};
        categories.forEach(function(cat, index) {
            catMap[cat.name] = index;
        });

        // 3. COLOR PALETTES (Optimized for Contrast)
        
        // Light Mode: Deep, professional tones (Readable on White)
        // Red (Self), Deep Purple, Navy Blue, Burnt Orange, Forest Green
        const lightColors = ['#c62828', '#6a1b9a', '#1565c0', '#ef6c00', '#2e7d32'];

        // Dark Mode: Neon, glowing tones (Readable on Black)
        // Neon Green (Self), Neon Purple, Electric Cyan, Bright Gold, Hot Orange
        const darkColors =  ['#00ff41', '#e040fb', '#00e5ff', '#ffd600', '#ff3d00'];

        function getOption(isDark) {
            let colors = isDark ? darkColors : lightColors;
            let bgColor = isDark ? '#000000' : '#ffffff';
            let textColor = isDark ? '#eeeeee' : '#333333';
            let edgeColor = isDark ? '#555555' : '#cccccc';

            return {
                backgroundColor: bgColor,
                tooltip: {
                    trigger: 'item',
                    backgroundColor: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)',
                    textStyle: { color: textColor }
                },
                color: colors,
                legend: [{
                    data: ['self', 'advisor', 'professor', 'collaborator', 'student'],
                    textStyle: { color: textColor, fontWeight: 'bold' },
                    bottom: 20,
                    selectedMode: 'multiple'
                }],
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: rawLinks,
                    categories: categories,
                    roam: true,
                    draggable: true,
                    label: { 
                        show: true, 
                        position: 'right', 
                        formatter: '{b}', 
                        color: textColor,
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    lineStyle: { 
                        color: 'source', 
                        curveness: 0.3,
                        width: 1.5,
                        opacity: 0.7
                    },
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: { width: 4, opacity: 1 },
                        label: { show: true }
                    },
                    // Physics Engine Settings (Spaced Out)
                    force: { 
                        repulsion: 2500,  // Increased from 1000 to push nodes apart
                        gravity: 0.1,    // Keeps them from flying off screen
                        edgeLength: 150,  // Longer links
                        friction: 0.6 
                    }
                }]
            };
        }

        // 4. RENDER FUNCTION
        function safeRender() {
            if (dom.clientWidth > 0 && dom.clientHeight > 0) {
                let isDark = document.body.classList.contains('dark');
                myChart.setOption(getOption(isDark));
                myChart.resize();
                
                // Re-center 'self' node
                var w = myChart.getWidth();
                var h = myChart.getHeight();
                nodes.forEach(n => {
                    if (n.id === 'self') { n.x = w / 2; n.y = h / 2; }
                });
                myChart.setOption({ series: [{ data: nodes }] });
                
                hasRendered = true;
            }
        }

        // 5. EVENT LISTENERS
        safeRender();

        var poller = setInterval(function() {
            if (dom.offsetParent !== null && !hasRendered) {
                safeRender();
            }
        }, 200);

        var parentDetails = dom.closest('details');
        if (parentDetails) {
            parentDetails.addEventListener('toggle', function() {
                if (parentDetails.open) {
                    setTimeout(safeRender, 50);
                }
            });
        }

        new ResizeObserver(() => {
            if (hasRendered) myChart.resize();
        }).observe(dom);

        const themeButton = document.querySelector('.js-theme-toggle');
        if(themeButton){
            themeButton.addEventListener('click', function(){
                setTimeout(function(){
                    let isDarkNow = document.body.classList.contains('dark');
                    myChart.setOption(getOption(isDarkNow));
                }, 100);
            });
        }
    });
})();
</script>
