{{/* Interactive Research Network - Usage: {{< research_network >}} */}}
{{/* Automatically builds co-authorship network from all publications */}}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

{{ $seed := "abcdefghijklmnopqrstuvwxyz" }}
{{ $uniqueID := delimit (shuffle (split $seed "")) "" }}
<div id="network-{{ $uniqueID }}" style="width: 100%; min-height: 600px; height: 600px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative;"></div>

<script type="text/javascript">
(function() {
    var domID = "network-{{ $uniqueID }}";
    
    // -----------------------------------------------------------
    // 1. AUTOMATICALLY SCRAPE DATA FROM YOUR SITE
    // -----------------------------------------------------------
    // We loop through ALL pages that have an 'authors' field.
    // This creates a raw JSON list of every paper you have written.
    var rawPapers = [
        {{ range where .Site.RegularPages "Params.authors" "!=" nil }}
        {
            title: "{{ .Title | safeJS }}",
            authors: {{ .Params.authors | jsonify }}
        },
        {{ end }}
    ];
    
    // Your specific internal username to replace with your real name
    var myInternalUsername = "admin"; 
    var myRealName = "Benjamin Ampel";

    document.addEventListener('DOMContentLoaded', function() {
        var dom = document.getElementById(domID);
        if (!dom) return;

        // -----------------------------------------------------------
        // 2. PROCESS DATA (JavaScript)
        // -----------------------------------------------------------
        var nodeMap = new Map(); // Stores unique authors
        var links = [];
        
        // Helper to normalize names (e.g., "admin" -> "Benjamin Ampel")
        function getName(rawName) {
            if (rawName === myInternalUsername) return myRealName;
            return rawName;
        }

        // A. Build Nodes and Links
        rawPapers.forEach(function(paper) {
            var authors = paper.authors.map(getName);
            
            // Register Nodes (Authors)
            authors.forEach(function(author) {
                if (!nodeMap.has(author)) {
                    nodeMap.set(author, { 
                        id: author, 
                        name: author, 
                        value: 1, // Number of papers (weight)
                        category: author === myRealName ? 0 : 1 // 0=Me, 1=Others
                    });
                } else {
                    // Increment paper count
                    nodeMap.get(author).value++;
                }
            });

            // Register Links (Co-authorship)
            // Connect every author to every other author in this paper
            for (var i = 0; i < authors.length; i++) {
                for (var j = i + 1; j < authors.length; j++) {
                    links.push({
                        source: authors[i],
                        target: authors[j]
                    });
                }
            }
        });

        // Convert Map to Array for ECharts
        var nodes = Array.from(nodeMap.values()).map(function(node) {
            return {
                id: node.id,
                name: node.name,
                // Size bubble based on number of papers (Min size 20, Max size 80)
                symbolSize: Math.max(20, Math.min(80, node.value * 10)),
                value: node.value,
                category: node.category,
                // Lock "You" to the center
                fixed: node.id === myRealName,
                x: node.id === myRealName ? dom.clientWidth / 2 : null,
                y: node.id === myRealName ? dom.clientHeight / 2 : null,
                label: {
                    show: node.value > 1 || node.id === myRealName // Only label frequent collaborators
                }
            };
        });

        // -----------------------------------------------------------
        // 3. SETUP ECHARTS
        // -----------------------------------------------------------
        var myChart = echarts.init(dom);
        
        // Simple Categories: Just "Me" and "Network"
        var categories = [{ name: 'Me' }, { name: 'Network' }];
        
        function getOption(isDark) {
            let bgColor = isDark ? '#000000' : '#fdfdfd';
            let textColor = isDark ? '#00ff41' : '#333333';
            let meColor = isDark ? '#00ff41' : '#d93025';     // Green (Cyber) or Red (Paper)
            let otherColor = isDark ? '#00ffff' : '#1a0dab';  // Cyan (Cyber) or Blue (Paper)

            return {
                backgroundColor: bgColor,
                tooltip: {
                    formatter: function(params) {
                        if (params.dataType === 'node') {
                            return '<strong>' + params.name + '</strong><br>Co-authored ' + params.value + ' papers';
                        }
                    }
                },
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: links,
                    categories: categories,
                    roam: true,
                    label: { 
                        position: 'right', 
                        color: textColor 
                    },
                    // Define colors manually for simplicity
                    itemStyle: {
                        color: function(params) {
                            return params.data.category === 0 ? meColor : otherColor;
                        }
                    },
                    lineStyle: { 
                        color: 'source', 
                        curveness: 0.3, 
                        opacity: 0.5 
                    },
                    force: { 
                        repulsion: 300, 
                        gravity: 0.1, 
                        edgeLength: 80 
                    }
                }]
            };
        }

        // -----------------------------------------------------------
        // 4. RENDER & EVENTS
        // -----------------------------------------------------------
        function safeRender() {
            if (dom.clientWidth > 0 && dom.clientHeight > 0) {
                let isDark = document.body.classList.contains('dark');
                myChart.setOption(getOption(isDark));
                myChart.resize();
                
                // Re-center "Me"
                var w = myChart.getWidth();
                var h = myChart.getHeight();
                nodes.forEach(n => {
                    if (n.id === myRealName) { n.x = w / 2; n.y = h / 2; }
                });
                myChart.setOption({ series: [{ data: nodes }] });
            }
        }

        // Initial Render
        safeRender();

        // Polling Check (For the accordion issue)
        var poller = setInterval(function() {
            if (dom.offsetParent !== null) {
                safeRender();
                clearInterval(poller); // Stop polling once rendered
            }
        }, 500);

        // Toggle Listener
        var parentDetails = dom.closest('details');
        if (parentDetails) {
            parentDetails.addEventListener('toggle', function() {
                if (parentDetails.open) setTimeout(safeRender, 50);
            });
        }

        // Resize Observer
        new ResizeObserver(() => myChart.resize()).observe(dom);

        // Theme Toggle Listener
        const themeButton = document.querySelector('.js-theme-toggle');
        if(themeButton){
            themeButton.addEventListener('click', function(){
                setTimeout(function(){
                    let isDarkNow = document.body.classList.contains('dark');
                    myChart.setOption(getOption(isDarkNow));
                }, 100);
            });
        }
    });
})();
</script>
