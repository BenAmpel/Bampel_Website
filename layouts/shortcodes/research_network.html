{{/* Interactive Research Network - Usage: {{< research_network >}} */}}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

{{ $seed := "abcdefghijklmnopqrstuvwxyz" }}
{{ $uniqueID := delimit (shuffle (split $seed "")) "" }}
<div id="network-{{ $uniqueID }}" style="width: 100%; min-height: 600px; height: 600px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative;"></div>

<script type="text/javascript">
(function() {
    var domID = "network-{{ $uniqueID }}";
    var rawNodes = {{ .Site.Data.network.nodes | jsonify }};
    var rawLinks = {{ .Site.Data.network.links | jsonify }};
    
    document.addEventListener('DOMContentLoaded', function() {
        var dom = document.getElementById(domID);
        if (!dom) return;

        // 1. DEFINE CATEGORIES FIRST (Order Matters!)
        var categories = [
            { name: 'self' },          // Index 0
            { name: 'advisor' },       // Index 1
            { name: 'professor' },     // Index 2
            { name: 'collaborator' },  // Index 3
            { name: 'student' }        // Index 4
        ];

        // 2. BUILD LOOKUP MAP (The Missing Piece)
        // Converts "advisor" -> 1, "student" -> 4
        var catMap = {};
        categories.forEach(function(cat, index) {
            catMap[cat.name] = index;
        });

        // 3. PREPARE DATA
        var nodes = rawNodes.map(node => ({
            id: node.id,
            name: node.name,
            symbolSize: node.size,
            // FIX: Use the map to get the Integer Index. Default to 0 if not found.
            category: catMap[node.group] !== undefined ? catMap[node.group] : 0,
            fixed: node.group === 'self' ? true : false,
            x: node.group === 'self' ? 500 : null,
            y: node.group === 'self' ? 300 : null
        }));

        // 4. SETUP ECHARTS
        var myChart = echarts.init(dom);
        var hasRendered = false;

        const lightColors = ['#d93025', '#9c27b0', '#1a0dab', '#f9ab00', '#188038'];
        const darkColors =  ['#00ff41', '#ff00ff', '#00ffff', '#ffff00', '#ff6b35'];

        function getOption(isDark) {
            let colors = isDark ? darkColors : lightColors;
            let bgColor = isDark ? '#000000' : '#fdfdfd';
            let textColor = isDark ? '#00ff41' : '#333333';

            return {
                backgroundColor: bgColor,
                tooltip: {},
                color: colors,
                legend: [{
                    data: ['self', 'advisor', 'professor', 'collaborator', 'student'],
                    textStyle: { color: textColor },
                    bottom: 10,
                    selectedMode: 'multiple'
                }],
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: rawLinks,
                    categories: categories, 
                    roam: true,
                    label: { 
                        show: true, 
                        position: 'right', 
                        formatter: '{b}', 
                        color: textColor 
                    },
                    lineStyle: { 
                        color: 'source', 
                        curveness: 0.3,
                        width: 2 
                    },
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: { width: 4 }
                    },
                    force: { 
                        repulsion: 1000, 
                        gravity: 0.1, 
                        edgeLength: 100, 
                        friction: 0.6 
                    }
                }]
            };
        }

        // 5. RENDER LOGIC
        function safeRender() {
            if (dom.clientWidth > 0 && dom.clientHeight > 0) {
                let isDark = document.body.classList.contains('dark');
                myChart.setOption(getOption(isDark));
                myChart.resize();
                
                // Re-center 'self' node
                var w = myChart.getWidth();
                var h = myChart.getHeight();
                nodes.forEach(n => {
                    if (n.id === 'self') { n.x = w / 2; n.y = h / 2; }
                });
                myChart.setOption({ series: [{ data: nodes }] });
                hasRendered = true;
            }
        }

        // A. Initial Try
        safeRender();

        // B. Polling (Backup for visibility issues)
        var poller = setInterval(function() {
            if (dom.offsetParent !== null && !hasRendered) {
                safeRender();
            }
        }, 200);

        // C. Toggle Listener
        var parentDetails = dom.closest('details');
        if (parentDetails) {
            parentDetails.addEventListener('toggle', function() {
                if (parentDetails.open) {
                    setTimeout(safeRender, 50);
                }
            });
        }

        // D. Resize Observer
        new ResizeObserver(() => {
            if (hasRendered) myChart.resize();
        }).observe(dom);

        // E. Theme Toggle
        const themeButton = document.querySelector('.js-theme-toggle');
        if(themeButton){
            themeButton.addEventListener('click', function(){
                setTimeout(function(){
                    let isDarkNow = document.body.classList.contains('dark');
                    myChart.setOption(getOption(isDarkNow));
                }, 100);
            });
        }
    });
})();
</script>
