{{/* Interactive Research Network - Usage: {{< research_network >}} */}}
{{/* Fetches publications.json and builds co-authorship network client-side */}}
{{/* Legend: 游댮 Self | 游릮 Advisor | 游댯 Professor | 游리 Collaborator | 游릭 Student */}}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

{{ $seed := "abcdefghijklmnopqrstuvwxyz" }}
{{ $uniqueID := delimit (shuffle (split $seed "")) "" }}
<div id="network-{{ $uniqueID }}" style="width: 100%; min-height: 700px; height: 700px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative;"></div>

<script type="text/javascript">
(function() {
    var domID = "network-{{ $uniqueID }}";
    var myName = "Benjamin Ampel"; // The center node

    // Name Normalization
    var nameMap = {
        'B Ampel': 'Benjamin Ampel', 'BM Ampel': 'Benjamin Ampel', 'B. Ampel': 'Benjamin Ampel', 'admin': 'Benjamin Ampel',
        'H Chen': 'Hsinchun Chen', 'H. Chen': 'Hsinchun Chen',
        'S Samtani': 'Sagar Samtani', 'S. Samtani': 'Sagar Samtani',
        'S Ullman': 'Steven Ullman', 'S. Ullman': 'Steven Ullman',
        'H Zhu': 'Hongyi Zhu', 'H. Zhu': 'Hongyi Zhu',
        'M Patton': 'Mark Patton', 'M. Patton': 'Mark Patton',
        'B Lazarine': 'Ben Lazarine', 'B. Lazarine': 'Ben Lazarine',
        'T Vahedi': 'Tala Vahedi', 'T. Vahedi': 'Tala Vahedi',
        'K Otto': 'Kaeli Otto', 'K. Otto': 'Kaeli Otto',
        'Y Gao': 'Yang Gao', 'Y. Gao': 'Yang Gao',
        'J Hu': 'James Hu', 'J. Hu': 'James Hu',
        'CH Yang': 'Chi-Heng Yang', 'JF Nunamaker Jr': 'Jay Nunamaker',
        'C Marx': 'Carolin Marx', 'C Dacosta': 'Cade Dacosta',
        'C Zhang': 'Chengjun Zhang', 'M Hashim': 'Matthew Hashim',
        'M Wagner': 'Mason Wagner', 'RY Reyes': 'Raul Reyes',
        'S Yang': 'Shanchieh Yang', 'Y Li': 'Yidong Li', 'Y. Li': 'Yidong Li'
    };

    // Category Assignment: Maps names to categories
    // Categories: 'self', 'advisor', 'professor', 'collaborator', 'student'
    var categoryMap = {
        'Benjamin Ampel': 'self',
        // Advisor
        'Hsinchun Chen': 'advisor',
        // Professors
        'Sagar Samtani': 'professor',
        'Jay Nunamaker': 'professor',
        'Mark Patton': 'professor',
        'Shanchieh Yang': 'professor',
        'Matthew Hashim': 'professor',
        // Students
        'Hongyi Zhu': 'student',
        'Ben Lazarine': 'student',
        'Steven Ullman': 'student',
        'Tala Vahedi': 'student',
        'Kaeli Otto': 'student',
        'Yang Gao': 'student',
        'James Hu': 'student',
        'Chi-Heng Yang': 'student',
        'Carolin Marx': 'student',
        'Cade Dacosta': 'student',
        'Chengjun Zhang': 'student',
        'Mason Wagner': 'student',
        'Raul Reyes': 'student',
        'Yidong Li': 'student'
        // Default: 'collaborator' (for anyone not listed)
    };

    function normalize(name) { return nameMap[name] || name; }
    function getCategory(name) { return categoryMap[name] || 'collaborator'; }

    // --- CATEGORY COLORS ---
    // 游댮 Self | 游릮 Advisor | 游댯 Professor | 游리 Collaborator | 游릭 Student
    var categoryColors = {
        light: {
            self: '#d93025',       // Red
            advisor: '#9c27b0',    // Purple
            professor: '#1a73e8',  // Blue
            collaborator: '#f9ab00', // Yellow/Orange
            student: '#188038'     // Green
        },
        dark: {
            self: '#ff4444',       // Bright Red
            advisor: '#e040fb',    // Bright Purple
            professor: '#448aff',  // Bright Blue
            collaborator: '#ffeb3b', // Bright Yellow
            student: '#00ff41'     // Matrix Green
        }
    };

    function getCategoryColor(category, isDark) {
        var palette = isDark ? categoryColors.dark : categoryColors.light;
        return palette[category] || palette.collaborator;
    }

    document.addEventListener('DOMContentLoaded', function() {
        var dom = document.getElementById(domID);
        if (!dom) return;

        var myChart = echarts.init(dom);
        myChart.showLoading();

        // Globals for theme switching
        var globalNodes = [], globalLinks = [];

        // 1. FETCH DATA
        fetch('/data/publications.json')
            .then(response => response.json())
            .then(data => {
                myChart.hideLoading();
                processData(data);
            })
            .catch(err => {
                console.error("Failed to load publications:", err);
                myChart.hideLoading();
                dom.innerHTML = "<p style='text-align:center; color:red;'>Could not load network data.</p>";
            });

        function processData(papers) {
            var nodeCounts = new Map();
            var connectedPairs = new Set();
            globalLinks = [];

            // A. Process Authors
            papers.forEach(function(paper) {
                if (!paper.authors) return;
                var authors = paper.authors.map(normalize);
                
                authors.forEach(auth => {
                    let count = (nodeCounts.get(auth) || 0) + 1;
                    nodeCounts.set(auth, count);
                });

                // Add Links
                for (let i = 0; i < authors.length; i++) {
                    for (let j = i + 1; j < authors.length; j++) {
                        let source = authors[i], target = authors[j];
                        if (source === target) continue;
                        let pairId = [source, target].sort().join("-");
                        if (!connectedPairs.has(pairId)) {
                            globalLinks.push({ source: source, target: target });
                            connectedPairs.add(pairId);
                        }
                    }
                }
            });

            // B. Build Nodes with Category Colors
            let isDark = document.body.classList.contains('dark');
            globalNodes = Array.from(nodeCounts.entries()).map(([name, count]) => {
                let isMe = (name === myName);
                let category = getCategory(name);
                
                return {
                    id: name, name: name, value: count, category: category,
                    symbolSize: isMe ? 65 : Math.max(20, Math.min(55, count * 10)),
                    itemStyle: { 
                        color: getCategoryColor(category, isDark),
                        borderColor: isDark ? '#222' : '#fff',
                        borderWidth: 2,
                        shadowBlur: 5, shadowColor: 'rgba(0,0,0,0.3)'
                    },
                    fixed: isMe,
                    x: isMe ? dom.clientWidth / 2 : null,
                    y: isMe ? dom.clientHeight / 2 : null,
                    label: { 
                        show: count > 1 || isMe || category === 'advisor' || category === 'professor', 
                        color: isDark ? '#eee' : '#333',
                        fontSize: isMe ? 14 : 11,
                        fontWeight: isMe ? 'bold' : 'normal'
                    },
                    z: isMe ? 10 : (category === 'advisor' ? 9 : 1)
                };
            });

            renderChart();
        }

        function renderChart() {
            let isDark = document.body.classList.contains('dark');
            let bgColor = isDark ? '#111' : '#fdfdfd';
            let textColor = isDark ? '#eee' : '#333';

            var option = {
                backgroundColor: bgColor,
                title: {
                    text: 'Research Collaboration Network',
                    subtext: '游댮 Self  |  游릮 Advisor  |  游댯 Professor  |  游리 Collaborator  |  游릭 Student',
                    left: 'center',
                    top: 15,
                    textStyle: { color: textColor, fontSize: 18 },
                    subtextStyle: { color: isDark ? '#ccc' : '#555', fontSize: 13 }
                },
                tooltip: { 
                    formatter: (params) => {
                        if (params.dataType === 'node') {
                            let cat = params.data.category;
                            let catLabel = cat.charAt(0).toUpperCase() + cat.slice(1);
                            return `<strong>${params.name}</strong><br>${catLabel}<br>Co-authored ${params.value} papers`;
                        }
                    },
                    backgroundColor: isDark ? 'rgba(50,50,50,0.95)' : 'rgba(255,255,255,0.95)',
                    textStyle: { color: textColor },
                    borderColor: isDark ? '#444' : '#ddd',
                    borderWidth: 1
                },
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: globalNodes,
                    links: globalLinks,
                    roam: true,
                    zoom: 0.8,
                    lineStyle: { 
                        color: isDark ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.08)',
                        curveness: 0.2, 
                        width: 1.5
                    },
                    force: { 
                        repulsion: 2000,
                        gravity: 0.05,
                        edgeLength: [100, 300],
                        friction: 0.8
                    }
                }]
            };

            myChart.setOption(option);
            
            // Re-center "Me"
            var w = myChart.getWidth(), h = myChart.getHeight();
            globalNodes.forEach(n => { if (n.name === myName) { n.x = w / 2; n.y = h / 2; } });
            myChart.setOption({ series: [{ data: globalNodes }] });
        }

        // Standard Events
        new ResizeObserver(() => myChart.resize()).observe(dom);
        var parentDetails = dom.closest('details');
        if (parentDetails) parentDetails.addEventListener('toggle', () => { if(parentDetails.open) setTimeout(() => myChart.resize(), 50); });
        
        // Theme Toggle Listener - Re-calculates Colors
        const themeButton = document.querySelector('.js-theme-toggle');
        if(themeButton){
            themeButton.addEventListener('click', () => {
                setTimeout(() => {
                    let isDarkNow = document.body.classList.contains('dark');
                    
                    // Update all node colors based on new theme
                    globalNodes.forEach(n => {
                        n.itemStyle.color = getCategoryColor(n.category, isDarkNow);
                        n.itemStyle.borderColor = isDarkNow ? '#222' : '#fff';
                        n.label.color = isDarkNow ? '#eee' : '#333';
                    });
                    
                    renderChart();
                }, 100);
            });
        }
    });
})();
</script>
