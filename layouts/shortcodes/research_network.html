{{/* Interactive Research Network - Usage: {{< research_network >}} */}}

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

{{ $seed := "abcdefghijklmnopqrstuvwxyz" }}
{{ $uniqueID := delimit (shuffle (split $seed "")) "" }}
<div id="network-{{ $uniqueID }}" style="width: 100%; min-height: 600px; height: 600px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; position: relative;"></div>

<script type="text/javascript">
(function() {
    var domID = "network-{{ $uniqueID }}";
    var rawNodes = {{ .Site.Data.network.nodes | jsonify }};
    var rawLinks = {{ .Site.Data.network.links | jsonify }};
    
    document.addEventListener('DOMContentLoaded', function() {
        var dom = document.getElementById(domID);
        if (!dom) return;

        // 2. SETUP ECHARTS
        var myChart = echarts.init(dom);
        var hasRendered = false; // Track if we have successfully drawn it
        
        // Prepare Data
        var nodes = rawNodes.map(node => ({
            id: node.id,
            name: node.name,
            symbolSize: node.size,
            category: node.group,
            fixed: node.group === 'self' ? true : false,
            x: node.group === 'self' ? 500 : null,
            y: node.group === 'self' ? 300 : null
        }));

        const lightColors = ['#d93025', '#1a0dab', '#f9ab00', '#007b83', '#666666'];
        const darkColors = ['#00ff41', '#00ffff', '#ffff00', '#ff00ff', '#ffffff'];

        function getOption(isDark) {
            let colors = isDark ? darkColors : lightColors;
            let bgColor = isDark ? '#000000' : '#fdfdfd';
            let textColor = isDark ? '#00ff41' : '#333333';

            return {
                backgroundColor: bgColor,
                tooltip: {},
                color: colors,
                legend: [{
                    data: ['self', 'professor', 'student', 'external', 'industry'],
                    textStyle: { color: textColor },
                    bottom: 10
                }],
                series: [{
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: rawLinks,
                    categories: [
                        { name: 'self' }, { name: 'professor' }, { name: 'student' }, { name: 'external' }, { name: 'industry' }
                    ],
                    roam: true,
                    label: { show: true, position: 'right', formatter: '{b}', color: textColor },
                    lineStyle: { color: 'source', curveness: 0.3 },
                    force: { repulsion: 1000, gravity: 0.1, edgeLength: 100, friction: 0.6 }
                }]
            };
        }

        // Initial Render Attempt
        let isDark = document.body.classList.contains('dark');
        myChart.setOption(getOption(isDark));

        // 3. THE "POLLING" FIX
        // Check every 500ms if the box is visible. If it is, and we haven't resized recently, force it.
        // This catches the accordion opening event even if the browser suppresses the event trigger.
        setInterval(function() {
            if (dom.offsetParent !== null && !hasRendered) {
               // Element is now visible!
               myChart.resize();
               
               // Re-center self
               var w = myChart.getWidth();
               var h = myChart.getHeight();
               if(w > 0 && h > 0) {
                   nodes.forEach(n => {
                       if (n.id === 'self') { n.x = w / 2; n.y = h / 2; }
                   });
                   myChart.setOption({ series: [{ data: nodes }] });
                   hasRendered = true; // Stop trying to force it
               }
            }
        }, 500);

        // 4. Force Resize on Click (Backup)
        // If the user clicks anywhere in the box, we force a redraw
        dom.addEventListener('click', function() {
            myChart.resize();
        });

        // 5. Standard Resize Observer
        new ResizeObserver(() => {
            myChart.resize();
        }).observe(dom);

        // Theme Listener
        const themeButton = document.querySelector('.js-theme-toggle');
        if(themeButton){
            themeButton.addEventListener('click', function(){
                setTimeout(function(){
                    let isDarkNow = document.body.classList.contains('dark');
                    myChart.setOption(getOption(isDarkNow));
                }, 100);
            });
        }
    });
})();
</script>
