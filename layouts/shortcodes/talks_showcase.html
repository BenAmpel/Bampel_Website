<div class="talks-showcase" id="talks-showcase">
  <div class="talks-header">
    <div>
      <div class="talks-title">Talks Timeline</div>
      <div class="talks-subtitle">Invited talks, workshops, and conference presentations</div>
    </div>
    <div class="talks-summary" id="talks-summary"></div>
  </div>
  <div class="talks-controls">
    <div class="talks-years" id="talks-years" role="tablist" aria-label="Talk years"></div>
    <div class="talks-tags" id="talks-tags" role="tablist" aria-label="Talk topic filters"></div>
  </div>
  <div class="talks-cards" id="talks-cards"></div>
</div>

<script type="text/javascript">
(function () {
  const root = document.getElementById('talks-showcase');
  if (!root) return;

  const summaryEl = document.getElementById('talks-summary');
  const yearsEl = document.getElementById('talks-years');
  const tagsEl = document.getElementById('talks-tags');
  const cardsEl = document.getElementById('talks-cards');

  const safeFetch = (url) => fetch(url).then((r) => (r.ok ? r.json() : null)).catch(() => null);
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  const normalize = (item) => {
    const rawDate = String(item.date || '');
    let year = Number(item.year);
    let month = null;
    const match = rawDate.match(/^(\d{4})-(\d{2})/);
    if (match) {
      year = Number(match[1]);
      month = Number(match[2]);
    }

    const dateLabel = Number.isFinite(month) && month >= 1 && month <= 12
      ? `${monthNames[month - 1]} ${year}`
      : (Number.isFinite(year) ? `${year}` : '');

    const tags = Array.isArray(item.tags) ? item.tags.filter(Boolean) : [];

    return {
      title: item.title || '',
      event: item.event || '',
      location: item.location || '',
      type: item.type || 'Talk',
      year,
      month,
      dateLabel,
      tags
    };
  };

  const slugify = (value) => String(value || '')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');

  safeFetch('/data/talks.json').then((raw) => {
    const items = Array.isArray(raw) ? raw.map(normalize).filter((x) => Number.isFinite(x.year)) : [];
    if (!items.length) {
      cardsEl.textContent = 'No talk data available.';
      return;
    }

    items.sort((a, b) => (b.year * 100 + (b.month || 0)) - (a.year * 100 + (a.month || 0)));

    const years = Array.from(new Set(items.map((item) => item.year))).sort((a, b) => a - b);
    const yearCounts = years.reduce((acc, year) => {
      acc.set(year, items.filter((item) => item.year === year).length);
      return acc;
    }, new Map());

    const venues = new Set(items.map((item) => item.event).filter(Boolean));
    const yearRange = years.length ? `${years[0]}–${years[years.length - 1]}` : '';
    summaryEl.textContent = `${items.length} talks • ${venues.size} venues${yearRange ? ` • ${yearRange}` : ''}`;

    const tagCounts = new Map();
    items.forEach((item) => {
      item.tags.forEach((tag) => {
        tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
      });
    });

    const tags = Array.from(tagCounts.keys()).sort((a, b) => tagCounts.get(b) - tagCounts.get(a));

    let activeYear = years[years.length - 1];
    let activeTag = 'All';

    const setActiveYear = (year) => {
      activeYear = year;
      yearsEl.querySelectorAll('.talks-year').forEach((button) => {
        button.classList.toggle('active', Number(button.dataset.year) === year);
        button.setAttribute('aria-selected', Number(button.dataset.year) === year ? 'true' : 'false');
      });
      renderCards();
    };

    const setActiveTag = (tag) => {
      activeTag = tag;
      tagsEl.querySelectorAll('.talks-tag').forEach((button) => {
        button.classList.toggle('active', button.dataset.tag === tag);
        button.setAttribute('aria-selected', button.dataset.tag === tag ? 'true' : 'false');
      });
      renderCards();
    };

    const renderCards = () => {
      const filtered = items.filter((item) => item.year === activeYear)
        .filter((item) => activeTag === 'All' || item.tags.includes(activeTag));

      if (!filtered.length) {
        cardsEl.innerHTML = `<div class="talks-empty">No talks for ${activeYear} with ${activeTag}.</div>`;
        return;
      }

      cardsEl.innerHTML = filtered.map((item) => {
        const typeClass = slugify(item.type);
        const tagMarkup = item.tags.length
          ? `<div class="talks-card-tags">${item.tags.map((tag) => `<span class="talks-tag-chip">${tag}</span>`).join('')}</div>`
          : '';

        const metaBits = [item.event, item.location].filter(Boolean);
        const meta = metaBits.length ? `<div class="talks-card-meta">${metaBits.join(' • ')}</div>` : '';

        return `
          <div class="talks-card">
            <div class="talks-card-header">
              <span>${item.dateLabel}</span>
              <span class="talks-type ${typeClass}">${item.type}</span>
            </div>
            <div class="talks-card-title">${item.title}</div>
            ${meta}
            ${tagMarkup}
          </div>
        `;
      }).join('');
    };

    yearsEl.innerHTML = years.map((year) => {
      const count = yearCounts.get(year) || 0;
      return `
        <button class="talks-year" type="button" data-year="${year}" aria-selected="false">
          <span>${year}</span>
          <span class="count">${count}</span>
        </button>
      `;
    }).join('');

    yearsEl.querySelectorAll('.talks-year').forEach((button) => {
      button.addEventListener('click', () => setActiveYear(Number(button.dataset.year)));
    });

    const tagButtons = ['All', ...tags];
    tagsEl.innerHTML = tagButtons.map((tag) => (
      `<button class="talks-tag" type="button" data-tag="${tag}" aria-selected="false">${tag}</button>`
    )).join('');

    tagsEl.querySelectorAll('.talks-tag').forEach((button) => {
      button.addEventListener('click', () => setActiveTag(button.dataset.tag));
    });

    setActiveTag('All');
    setActiveYear(activeYear);
  });
})();
</script>
