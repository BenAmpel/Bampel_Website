{{/* Altmetric Aggregator - Usage: {{< altmetric_summary >}} */}}

{{ $dois := slice }}
{{ range where .Site.RegularPages "Section" "in" (slice "journal_publication" "conference_publication" "workshop_publication") }}
  {{ if .Params.doi }}
    {{ $dois = $dois | append .Params.doi }}
  {{ end }}
{{ end }}

<div id="altmetric-summary-box" style="display:none; margin: 30px 0; padding: 25px; background: var(--card-bg, rgba(255,255,255,0.02)); border: 1px solid var(--card-border, #333); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
    <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--card-border, #444); padding-bottom:15px;">
        <img src="https://d1bxh8uas1mnw7.cloudfront.net/assets/altmetric_badges/donut-small.png" style="width:32px; height:32px; opacity:0.9;" alt="Altmetric Logo">
        <div>
            <h4 style="margin:0; font-size:1.1rem; font-weight:700; color:inherit;">Cumulative Research Attention</h4>
            <span style="font-size:0.8rem; opacity:0.7;">Aggregated impact across news, policy, and social media</span>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:20px; text-align:center;">
        <div>
            <div id="am-total-score" style="font-size:2rem; font-weight:800; color:#00e5ff;">0</div>
            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; opacity:0.7; margin-top:5px;">Total Score</div>
        </div>
        <div>
            <div id="am-news" style="font-size:1.5rem; font-weight:700; color:inherit;">0</div>
            <div style="font-size:0.75rem; opacity:0.6; margin-top:5px;">News Stories</div>
        </div>
        <div>
            <div id="am-policy" style="font-size:1.5rem; font-weight:700; color:inherit;">0</div>
            <div style="font-size:0.75rem; opacity:0.6; margin-top:5px;">Policy Docs</div>
        </div>
        <div>
            <div id="am-twitter" style="font-size:1.5rem; font-weight:700; color:inherit;">0</div>
            <div style="font-size:0.75rem; opacity:0.6; margin-top:5px;">Social Mentions</div>
        </div>
    </div>
</div>

<script type="text/javascript">
(function() {
    const DOIS = {{ $dois | jsonify }};
    const CACHE_KEY = 'altmetric_aggregate_cache';
    const CACHE_DURATION = 1000 * 60 * 60 * 24; // 24 Hours

    function updateUI(stats) {
        // Reveal the box
        const box = document.getElementById('altmetric-summary-box');
        if (box) box.style.display = 'block';

        animateValue('am-total-score', 0, stats.score, 1000);
        document.getElementById('am-news').innerText = stats.news;
        document.getElementById('am-policy').innerText = stats.policy;
        document.getElementById('am-twitter').innerText = stats.twitter;
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    async function fetchAll() {
        // 1. Check Cache
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < CACHE_DURATION) {
                    console.log("Loaded Altmetric data from cache");
                    updateUI(data.stats);
                    return;
                }
            } catch (e) { localStorage.removeItem(CACHE_KEY); }
        }

        let stats = { score: 0, news: 0, policy: 0, twitter: 0 };
        
        // 2. Fetch sequentially with delay (Polite Mode)
        for (const doi of DOIS) {
            try {
                const res = await fetch(`https://api.altmetric.com/v1/doi/${doi}`);
                if (res.ok) {
                    const d = await res.json();
                    stats.score += (d.score || 0);
                    stats.news += (d.cited_by_msm_count || 0);
                    stats.policy += (d.cited_by_policies_count || 0);
                    stats.twitter += (d.cited_by_tweeters_count || 0);
                }
            } catch (e) { console.warn('Altmetric skip:', doi); }
            
            // 50ms pause between requests to be polite
            await new Promise(r => setTimeout(r, 50)); 
        }

        // 3. Save & Render
        localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), stats: stats }));
        updateUI(stats);
    }

    // Force display if DOIS exist, even if fetch fails or returns 0
    if(DOIS && DOIS.length > 0) {
        fetchAll();
    } else {
        // Optional: Show box with 0s if no DOIs found in site
        // document.getElementById('altmetric-summary-box').style.display = 'block';
    }
})();
</script>
