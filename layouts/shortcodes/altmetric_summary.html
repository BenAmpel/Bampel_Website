<script type="text/javascript">
(function() {
    const DOIS = {{ $dois | jsonify }};
    const CACHE_KEY = 'altmetric_aggregate_cache';
    const CACHE_DURATION = 1000 * 60 * 60 * 24; // 24 Hours

    function updateUI(stats) {
        // Animate numbers for a nice effect
        animateValue('am-total-score', 0, stats.score, 1000);
        document.getElementById('am-news').innerText = stats.news;
        document.getElementById('am-policy').innerText = stats.policy;
        document.getElementById('am-twitter').innerText = stats.twitter;
        document.getElementById('altmetric-summary-box').style.display = 'block';
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    async function fetchAll() {
        // 1. Check Cache
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            const data = JSON.parse(cached);
            if (Date.now() - data.timestamp < CACHE_DURATION) {
                console.log("Loaded Altmetric data from cache");
                updateUI(data.stats);
                return;
            }
        }

        let stats = { score: 0, news: 0, policy: 0, twitter: 0 };
        
        // 2. Fetch sequentially with delay (Polite Mode)
        for (const doi of DOIS) {
            try {
                const res = await fetch(`https://api.altmetric.com/v1/doi/${doi}`);
                if (res.ok) {
                    const d = await res.json();
                    stats.score += (d.score || 0);
                    stats.news += (d.cited_by_msm_count || 0);
                    stats.policy += (d.cited_by_policies_count || 0);
                    stats.twitter += (d.cited_by_tweeters_count || 0);
                }
            } catch (e) { console.warn('Altmetric skip:', doi); }
            
            // 50ms pause between requests to be polite
            await new Promise(r => setTimeout(r, 50)); 
        }

        // 3. Save & Render
        localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), stats: stats }));
        updateUI(stats);
    }

    if(DOIS && DOIS.length > 0) fetchAll();
})();
</script>
